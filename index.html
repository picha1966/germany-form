<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ============================================
           RESET & BASE - TELEGRAM THEME INTEGRATION
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Telegram Theme Variables with Fallbacks */
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1a1a1a);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #3390ec);
            --button-color: var(--tg-theme-button-color, #4caf50);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);

            /* Custom App Variables */
            --border-color: #e0e0e0;
            --border-focus: var(--link-color);
            --error-color: #e53935;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --button-disabled: #cccccc;
            --input-bg: var(--secondary-bg);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
        }

        /* ============================================
           CONTAINER
           ============================================ */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 140px;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: var(--hint-color);
        }

        /* ============================================
           DRAFT RESTORED BANNER
           ============================================ */
        .draft-banner {
            background-color: #fff3e0;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid var(--warning-color);
        }

        .draft-banner.visible {
            display: flex;
        }

        .draft-banner-text {
            display: flex;
            align-items: center;
        }

        .draft-banner-text .icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .draft-banner .clear-draft-btn {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .draft-banner .clear-draft-btn:active {
            background-color: rgba(229, 57, 53, 0.1);
        }

        /* Dark theme for draft banner */
        @media (prefers-color-scheme: dark) {
            .draft-banner {
                background-color: #3d2e1a;
            }
        }

        /* ============================================
           SECTION HEADERS
           ============================================ */
        .section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        /* ============================================
           FORM GROUP
           ============================================ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .form-group label .required {
            color: var(--error-color);
            margin-left: 2px;
        }

        /* ============================================
           INPUT FIELDS - CRITICAL FOR TELEGRAM WEBAPP
           NO aggressive event interception!
           ============================================ */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;

            /* CRITICAL: Stability for Telegram WebApp on iOS/Desktop */
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group textarea {
            min-height: 90px;
            resize: vertical;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
            cursor: pointer;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.15);
        }

        .form-group input.valid,
        .form-group select.valid,
        .form-group textarea.valid {
            border-color: var(--success-color);
        }

        .form-group input.invalid,
        .form-group select.invalid,
        .form-group textarea.invalid {
            border-color: var(--error-color);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--hint-color);
            opacity: 0.8;
        }

        /* ============================================
           ERROR HINT (ON-SCREEN, NO POPUPS!)
           ============================================ */
        .error-hint {
            font-size: 12px;
            color: var(--error-color);
            margin-top: 4px;
            min-height: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .error-hint.visible {
            visibility: visible;
            opacity: 1;
        }

        /* ============================================
           VALIDATION STATUS BANNER
           ============================================ */
        .validation-status {
            background-color: var(--input-bg);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .validation-status.incomplete {
            border-left: 3px solid var(--error-color);
        }

        .validation-status.complete {
            border-left: 3px solid var(--success-color);
        }

        .validation-status .icon {
            margin-right: 8px;
            font-size: 16px;
        }

        /* ============================================
           DYNAMIC SECTIONS - Hidden by default
           ============================================ */
        .form-section {
            display: none;
        }

        .form-section.visible {
            display: block;
        }

        /* ============================================
           SUBMIT BUTTON - FIXED AT BOTTOM
           ============================================ */
        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(transparent, var(--bg-color) 30%);
            z-index: 100;
        }

        .submit-btn {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: block;
            padding: 16px 24px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;

            /* Prevent tap highlight on iOS */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .submit-btn:disabled {
            background-color: var(--button-disabled);
            color: #888888;
            cursor: not-allowed;
        }

        .submit-btn:not(:disabled) {
            background-color: var(--button-color);
            color: var(--button-text-color);
        }

        .submit-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        .submit-btn.loading {
            background-color: var(--hint-color);
            pointer-events: none;
        }

        /* ============================================
           FORM FOOTER
           ============================================ */
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--hint-color);
        }

        .draft-status {
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .draft-status.visible {
            opacity: 1;
        }

        .draft-status .icon {
            margin-right: 4px;
            font-size: 12px;
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 360px) {
            .container {
                padding: 16px 12px 140px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px 14px;
                font-size: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .draft-banner {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header (Dynamic) -->
        <div class="header">
            <h1 id="formTitle">Document Form</h1>
            <p id="formDescription">Fill in the required information</p>
        </div>

        <!-- Draft Restored Banner -->
        <div class="draft-banner" id="draftBanner">
            <div class="draft-banner-text">
                <span class="icon">üìù</span>
                <span id="draftBannerText">–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—É –∞–Ω–∫–µ—Ç—É</span>
            </div>
            <button type="button" class="clear-draft-btn" id="clearDraftBtn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <!-- Validation Status Banner -->
        <div class="validation-status incomplete" id="validationStatus">
            <span class="icon" id="statusIcon">‚ö†Ô∏è</span>
            <span id="statusText">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</span>
        </div>

        <!-- Form -->
        <form id="masterForm" autocomplete="off" novalidate>

            <!-- ========== PERSONAL (Common) ========== -->
            <div class="form-section visible" id="section_personal">
                <div class="section-header" id="hdr_personal">Personal Information</div>

                <!-- first_name -->
                <div class="form-group">
                    <label for="first_name" id="lbl_first_name">
                        First Name <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="first_name"
                        name="first_name"
                        placeholder="Enter your first name"
                        autocomplete="given-name"
                        data-section="personal"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="first_name_error">Minimum 2 characters</div>
                </div>

                <!-- last_name -->
                <div class="form-group">
                    <label for="last_name" id="lbl_last_name">
                        Last Name <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="last_name"
                        name="last_name"
                        placeholder="Enter your last name"
                        autocomplete="family-name"
                        data-section="personal"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="last_name_error">Minimum 2 characters</div>
                </div>

                <!-- birth_date -->
                <div class="form-group">
                    <label for="birth_date" id="lbl_birth_date">
                        Date of Birth <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="birth_date"
                        name="birth_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="personal"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="birth_date_error">Format: DD.MM.YYYY</div>
                </div>

                <!-- birth_place -->
                <div class="form-group">
                    <label for="birth_place" id="lbl_birth_place">
                        Place of Birth <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="birth_place"
                        name="birth_place"
                        placeholder="e.g., Kyiv"
                        data-section="personal"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="birth_place_error">Minimum 2 characters</div>
                </div>

                <!-- nationality -->
                <div class="form-group">
                    <label for="nationality" id="lbl_nationality">
                        Nationality <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="nationality"
                        name="nationality"
                        placeholder="e.g., Ukrainian"
                        data-section="personal"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="nationality_error">Minimum 2 characters</div>
                </div>

                <!-- marital_status -->
                <div class="form-group">
                    <label for="marital_status" id="lbl_marital_status">
                        Marital Status <span class="required">*</span>
                    </label>
                    <select
                        id="marital_status"
                        name="marital_status"
                        data-section="personal"
                        data-required="true"
                    >
                        <option value="" id="opt_ms_empty">-- Select --</option>
                        <option value="single" id="opt_ms_single">Single</option>
                        <option value="married" id="opt_ms_married">Married</option>
                        <option value="divorced" id="opt_ms_divorced">Divorced</option>
                        <option value="widowed" id="opt_ms_widowed">Widowed</option>
                        <option value="separated" id="opt_ms_separated">Separated</option>
                        <option value="civil_union" id="opt_ms_cu">Civil Union</option>
                    </select>
                    <div class="error-hint" id="marital_status_error">Please select</div>
                </div>

                <!-- religion -->
                <div class="form-group">
                    <label for="religion" id="lbl_religion">
                        Religion <span class="required">*</span>
                    </label>
                    <select
                        id="religion"
                        name="religion"
                        data-section="personal"
                        data-required="true"
                    >
                        <option value="" id="opt_rel_empty">-- Select --</option>
                        <option value="none" id="opt_rel_none">None</option>
                        <option value="protestant" id="opt_rel_prot">Protestant</option>
                        <option value="catholic" id="opt_rel_cath">Catholic</option>
                        <option value="orthodox" id="opt_rel_orth">Orthodox</option>
                        <option value="muslim" id="opt_rel_mus">Muslim</option>
                        <option value="jewish" id="opt_rel_jew">Jewish</option>
                        <option value="other" id="opt_rel_other">Other</option>
                    </select>
                    <div class="error-hint" id="religion_error">Please select</div>
                </div>
            </div>

            <!-- ========== ADDRESS (Common/Anmeldung/Payments) ========== -->
            <div class="form-section" id="section_address">
                <div class="section-header" id="hdr_address">Address</div>

                <!-- street -->
                <div class="form-group">
                    <label for="street" id="lbl_street">
                        Street <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="street"
                        name="street"
                        placeholder="e.g., Hauptstra√üe"
                        autocomplete="street-address"
                        data-section="address"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="street_error">Minimum 2 characters</div>
                </div>

                <!-- house_number -->
                <div class="form-group">
                    <label for="house_number" id="lbl_house_number">
                        House Number <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="house_number"
                        name="house_number"
                        placeholder="e.g., 15a"
                        data-section="address"
                        data-required="true"
                        data-min="1"
                    >
                    <div class="error-hint" id="house_number_error">Required</div>
                </div>

                <!-- postal_code -->
                <div class="form-group">
                    <label for="postal_code" id="lbl_postal_code">
                        Postal Code (PLZ) <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="postal_code"
                        name="postal_code"
                        placeholder="12345"
                        inputmode="numeric"
                        maxlength="5"
                        data-section="address"
                        data-required="true"
                        data-format="plz"
                    >
                    <div class="error-hint" id="postal_code_error">Exactly 5 digits</div>
                </div>

                <!-- city -->
                <div class="form-group">
                    <label for="city" id="lbl_city">
                        City <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="city"
                        name="city"
                        placeholder="e.g., Berlin"
                        autocomplete="address-level2"
                        data-section="address"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="city_error">Minimum 2 characters</div>
                </div>

                <!-- previous_address (Anmeldung only) -->
                <div class="form-group">
                    <label for="previous_address" id="lbl_previous_address">
                        Previous Address
                    </label>
                    <input
                        type="text"
                        id="previous_address"
                        name="previous_address"
                        placeholder="e.g., Alte Stra√üe 15, 10117 Berlin"
                        data-section="address"
                        data-required="false"
                        data-min="0"
                    >
                    <div class="error-hint" id="previous_address_error"></div>
                </div>

                <!-- move_in_date (Anmeldung only) -->
                <div class="form-group">
                    <label for="move_in_date" id="lbl_move_in_date">
                        Move-in Date <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="move_in_date"
                        name="move_in_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="address"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="move_in_date_error">Format: DD.MM.YYYY</div>
                </div>
            </div>

            <!-- ========== HOUSING (Anmeldung) ========== -->
            <div class="form-section" id="section_housing">
                <div class="section-header" id="hdr_housing">Housing</div>

                <!-- landlord_name -->
                <div class="form-group">
                    <label for="landlord_name" id="lbl_landlord_name">
                        Landlord Name <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="landlord_name"
                        name="landlord_name"
                        placeholder="Name of landlord"
                        data-section="housing"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="landlord_name_error">Minimum 2 characters</div>
                </div>
            </div>

            <!-- ========== BANK (Kindergeld/Wohngeld etc.) ========== -->
            <div class="form-section" id="section_bank">
                <div class="section-header" id="hdr_bank">Bank Details</div>

                <!-- iban -->
                <div class="form-group">
                    <label for="iban" id="lbl_iban">
                        IBAN <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="iban"
                        name="iban"
                        placeholder="DE00 0000 0000 0000 0000 00"
                        inputmode="text"
                        maxlength="42"
                        data-section="bank"
                        data-required="true"
                        data-format="iban"
                    >
                    <div class="error-hint" id="iban_error">Enter a valid IBAN</div>
                </div>

                <!-- bic -->
                <div class="form-group">
                    <label for="bic" id="lbl_bic">
                        BIC <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="bic"
                        name="bic"
                        placeholder="e.g., COBADEFFXXX"
                        inputmode="text"
                        maxlength="11"
                        data-section="bank"
                        data-required="true"
                        data-format="bic"
                    >
                    <div class="error-hint" id="bic_error">8‚Äì11 characters</div>
                </div>

                <!-- account_holder -->
                <div class="form-group">
                    <label for="account_holder" id="lbl_account_holder">
                        Account Holder <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="account_holder"
                        name="account_holder"
                        placeholder="e.g., Max Mustermann"
                        data-section="bank"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="account_holder_error">Minimum 2 characters</div>
                </div>
            </div>

            <!-- ========== CHILD (Kindergeld) ========== -->
            <div class="form-section" id="section_child">
                <div class="section-header" id="hdr_child">Child Information</div>

                <!-- child_first_name -->
                <div class="form-group">
                    <label for="child_first_name" id="lbl_child_first_name">
                        Child First Name <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="child_first_name"
                        name="child_first_name"
                        placeholder="Enter child's first name"
                        data-section="child"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="child_first_name_error">Minimum 2 characters</div>
                </div>

                <!-- child_last_name -->
                <div class="form-group">
                    <label for="child_last_name" id="lbl_child_last_name">
                        Child Last Name <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="child_last_name"
                        name="child_last_name"
                        placeholder="Enter child's last name"
                        data-section="child"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="child_last_name_error">Minimum 2 characters</div>
                </div>

                <!-- child_birth_date -->
                <div class="form-group">
                    <label for="child_birth_date" id="lbl_child_birth_date">
                        Child Birth Date <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="child_birth_date"
                        name="child_birth_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="child"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="child_birth_date_error">Format: DD.MM.YYYY</div>
                </div>

                <!-- child_birth_place -->
                <div class="form-group">
                    <label for="child_birth_place" id="lbl_child_birth_place">
                        Child Birth Place <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="child_birth_place"
                        name="child_birth_place"
                        placeholder="e.g., Berlin"
                        data-section="child"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="child_birth_place_error">Minimum 2 characters</div>
                </div>

                <!-- child_nationality -->
                <div class="form-group">
                    <label for="child_nationality" id="lbl_child_nationality">
                        Child Nationality <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="child_nationality"
                        name="child_nationality"
                        placeholder="e.g., German"
                        data-section="child"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="child_nationality_error">Minimum 2 characters</div>
                </div>
            </div>

            <!-- ========== SIGNATURE (Common) ========== -->
            <div class="form-section" id="section_signature">
                <div class="section-header" id="hdr_signature">Signature</div>

                <!-- signature_place -->
                <div class="form-group">
                    <label for="signature_place" id="lbl_signature_place">
                        Signature Place (City) <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="signature_place"
                        name="signature_place"
                        placeholder="e.g., Berlin"
                        data-section="signature"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="signature_place_error">Minimum 2 characters</div>
                </div>

                <!-- signature_date -->
                <div class="form-group">
                    <label for="signature_date" id="lbl_signature_date">
                        Signature Date <span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="signature_date"
                        name="signature_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="signature"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="signature_date_error">Format: DD.MM.YYYY</div>
                </div>
            </div>

        </form>

        <!-- Form Footer -->
        <div class="form-footer">
            <div class="field-counter">
                <span id="filledText">–ó–∞–ø–æ–≤–Ω–µ–Ω–æ:</span>
                <span id="filledCount">0</span> /
                <span id="totalCount">0</span>
                <span id="fieldsText">–ø–æ–ª—ñ–≤</span>
            </div>
            <div class="draft-status" id="draftStatus">
                <span class="icon">üíæ</span>
                <span id="draftSavedText">–ß–µ—Ä–Ω–µ—Ç–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞</span>
            </div>
        </div>
    </div>

    <!-- Submit Button (Fixed at bottom) -->
    <div class="submit-container">
        <button type="button" class="submit-btn" id="submitBtn" disabled>
            –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç
        </button>
    </div>

    <script>
        (function() {
            'use strict';

            // ============================================
            // URL PARAMS: doc_type, lang
            // ============================================
           function getParams() {
    var params = new URLSearchParams(window.location.search);

    var doc = params.get('doc_type') || 'anmeldung';
    var lang = params.get('lang') || 'ua';

    return {
        docType: doc.toLowerCase(),
        lang: lang.toLowerCase()
    };
}

var P = getParams();
var currentDocType = P.docType;
var currentLang = P.lang;

// üî• DEBUG ‚Äì —â–æ–± —Ç–∏ –±–∞—á–∏–≤ —É –∫–æ–Ω—Å–æ–ª—ñ
console.log("WEBAPP PARAMS:", {
    doc_type: currentDocType,
    lang: currentLang
});


            // ============================================
            // TELEGRAM WEBAPP INIT
            // ============================================
            var tg = window.Telegram && window.Telegram.WebApp;
            if (tg) {
                tg.ready();
                tg.expand();
            }

            // ============================================
            // TRANSLATIONS (minimal, no CSS changes)
            // ============================================
            var I18N = {
                ua: {
                    titles: {
                        anmeldung: "Anmeldung",
                        kindergeld: "Kindergeld"
                    },
                    descriptions: {
                        anmeldung: "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –º—ñ—Å—Ü–µ–º –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è",
                        kindergeld: "–ó–∞—è–≤–∞ –Ω–∞ –¥–æ–ø–æ–º–æ–≥—É –Ω–∞ –¥—ñ—Ç–µ–π"
                    },
                    ui: {
                        restored: "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—É –∞–Ω–∫–µ—Ç—É",
                        clear: "–û—á–∏—Å—Ç–∏—Ç–∏",
                        incomplete: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è",
                        ready: "–§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏",
                        filled: "–ó–∞–ø–æ–≤–Ω–µ–Ω–æ:",
                        fields: "–ø–æ–ª—ñ–≤",
                        draft_saved: "–ß–µ—Ä–Ω–µ—Ç–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞",
                        generating: "–ì–µ–Ω–µ—Ä—É—î–º–æ...",
                        submit: "–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç"
                    },
                    headers: {
                        personal: "–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ",
                        address: "–ê–¥—Ä–µ—Å–∞",
                        housing: "–ñ–∏—Ç–ª–æ",
                        bank: "–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏",
                        child: "–î–∞–Ω—ñ –¥–∏—Ç–∏–Ω–∏",
                        signature: "–ü—ñ–¥–ø–∏—Å"
                    },
                    labels: {
                        first_name: "–Ü–º'—è",
                        last_name: "–ü—Ä—ñ–∑–≤–∏—â–µ",
                        birth_date: "–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                        birth_place: "–ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                        nationality: "–ì—Ä–æ–º–∞–¥—è–Ω—Å—Ç–≤–æ",
                        marital_status: "–°—ñ–º–µ–π–Ω–∏–π —Å—Ç–∞–Ω",
                        religion: "–í—ñ—Ä–æ—Å–ø–æ–≤—ñ–¥–∞–Ω–Ω—è",
                        street: "–í—É–ª–∏—Ü—è",
                        house_number: "–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É",
                        postal_code: "–ü–æ—à—Ç–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å",
                        city: "–ú—ñ—Å—Ç–æ",
                        previous_address: "–ü–æ–ø–µ—Ä–µ–¥–Ω—è –∞–¥—Ä–µ—Å–∞",
                        move_in_date: "–î–∞—Ç–∞ –∑–∞—ó–∑–¥—É",
                        landlord_name: "–û—Ä–µ–Ω–¥–æ–¥–∞–≤–µ—Ü—å (–ü–Ü–ë)",
                        iban: "IBAN",
                        bic: "BIC",
                        account_holder: "–í–ª–∞—Å–Ω–∏–∫ —Ä–∞—Ö—É–Ω–∫—É",
                        child_first_name: "–Ü–º'—è –¥–∏—Ç–∏–Ω–∏",
                        child_last_name: "–ü—Ä—ñ–∑–≤–∏—â–µ –¥–∏—Ç–∏–Ω–∏",
                        child_birth_date: "–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏",
                        child_birth_place: "–ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏",
                        child_nationality: "–ì—Ä–æ–º–∞–¥—è–Ω—Å—Ç–≤–æ –¥–∏—Ç–∏–Ω–∏",
                        signature_place: "–ú—ñ—Å—Ç–æ –ø—ñ–¥–ø–∏—Å—É",
                        signature_date: "–î–∞—Ç–∞ –ø—ñ–¥–ø–∏—Å—É"
                    },
                    placeholders: {
                        birth_date: "DD.MM.YYYY",
                        move_in_date: "DD.MM.YYYY",
                        signature_date: "DD.MM.YYYY",
                        child_birth_date: "DD.MM.YYYY",
                        postal_code: "12345",
                        iban: "DE00 0000 0000 0000 0000 00",
                        bic: "COBADEFFXXX"
                    },
                    select: {
                        empty: "-- –û–±—Ä–∞—Ç–∏ --",
                        ms: {
                            single: "–ù–µ–æ–¥—Ä—É–∂–µ–Ω–∏–π/–Ω–µ–æ–¥—Ä—É–∂–µ–Ω–∞",
                            married: "–û–¥—Ä—É–∂–µ–Ω–∏–π/–∑–∞–º—ñ–∂–Ω—è",
                            divorced: "–†–æ–∑–ª—É—á–µ–Ω–∏–π/—Ä–æ–∑–ª—É—á–µ–Ω–∞",
                            widowed: "–í–¥—ñ–≤–µ—Ü—å/–≤–¥–æ–≤–∞",
                            separated: "–û–∫—Ä–µ–º–æ –ø—Ä–æ–∂–∏–≤–∞—î",
                            civil_union: "–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ"
                        },
                        rel: {
                            none: "–ù–µ–º–∞—î",
                            protestant: "–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç",
                            catholic: "–ö–∞—Ç–æ–ª–∏–∫",
                            orthodox: "–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∏–π",
                            muslim: "–ú—É—Å—É–ª—å–º–∞–Ω–∏–Ω",
                            jewish: "–Æ–¥–µ–π",
                            other: "–Ü–Ω—à–µ"
                        }
                    }
                },
                de: {
                    titles: { anmeldung: "Anmeldung", kindergeld: "Kindergeld" },
                    descriptions: { anmeldung: "Anmeldung (Wohnsitz registrieren)", kindergeld: "Antrag auf Kindergeld" },
                    ui: {
                        restored: "Entwurf wiederhergestellt",
                        clear: "L√∂schen",
                        incomplete: "Bitte Pflichtfelder ausf√ºllen",
                        ready: "Bereit zum Senden",
                        filled: "Ausgef√ºllt:",
                        fields: "Felder",
                        draft_saved: "Entwurf gespeichert",
                        generating: "Erstelle...",
                        submit: "Dokument erstellen"
                    },
                    headers: {
                        personal: "Pers√∂nliche Daten",
                        address: "Adresse",
                        housing: "Wohnung",
                        bank: "Bankdaten",
                        child: "Kind",
                        signature: "Unterschrift"
                    },
                    labels: {
                        first_name: "Vorname",
                        last_name: "Nachname",
                        birth_date: "Geburtsdatum",
                        birth_place: "Geburtsort",
                        nationality: "Staatsangeh√∂rigkeit",
                        marital_status: "Familienstand",
                        religion: "Religion",
                        street: "Stra√üe",
                        house_number: "Hausnummer",
                        postal_code: "PLZ",
                        city: "Ort",
                        previous_address: "Bisherige Anschrift",
                        move_in_date: "Einzugsdatum",
                        landlord_name: "Wohnungsgeber (Name)",
                        iban: "IBAN",
                        bic: "BIC",
                        account_holder: "Kontoinhaber",
                        child_first_name: "Vorname des Kindes",
                        child_last_name: "Nachname des Kindes",
                        child_birth_date: "Geburtsdatum des Kindes",
                        child_birth_place: "Geburtsort des Kindes",
                        child_nationality: "Staatsangeh√∂rigkeit des Kindes",
                        signature_place: "Ort (Unterschrift)",
                        signature_date: "Datum (Unterschrift)"
                    },
                    placeholders: {
                        birth_date: "TT.MM.JJJJ",
                        move_in_date: "TT.MM.JJJJ",
                        signature_date: "TT.MM.JJJJ",
                        child_birth_date: "TT.MM.JJJJ",
                        postal_code: "12345",
                        iban: "DE00 0000 0000 0000 0000 00",
                        bic: "COBADEFFXXX"
                    },
                    select: {
                        empty: "-- Ausw√§hlen --",
                        ms: {
                            single: "Ledig",
                            married: "Verheiratet",
                            divorced: "Geschieden",
                            widowed: "Verwitwet",
                            separated: "Getrennt lebend",
                            civil_union: "Eingetragene Partnerschaft"
                        },
                        rel: {
                            none: "Keine",
                            protestant: "Evangelisch",
                            catholic: "Katholisch",
                            orthodox: "Orthodox",
                            muslim: "Muslimisch",
                            jewish: "J√ºdisch",
                            other: "Andere"
                        }
                    }
                }
            };

            function t(path, fallback) {
                var pack = I18N[currentLang] || I18N.ua;
                var parts = path.split(".");
                var cur = pack;
                for (var i = 0; i < parts.length; i++) {
                    if (!cur || typeof cur !== "object") return fallback;
                    cur = cur[parts[i]];
                }
                return (cur === undefined || cur === null) ? fallback : cur;
            }

            // ============================================
            // DOC TYPE ‚Üí SECTIONS
            // ============================================
            var DOCS = {
                anmeldung: {
                    sections: ["personal", "address", "housing", "signature"],
                    showPreviousAddress: true,
                    showMoveInDate: true,
                    showBank: false,
                    showChild: false
                },
                kindergeld: {
                    sections: ["personal", "address", "bank", "child", "signature"],
                    showPreviousAddress: false,
                    showMoveInDate: false,
                    showBank: true,
                    showChild: true
                }
            };

            if (!DOCS[currentDocType]) currentDocType = "anmeldung";

            // ============================================
            // DOM ELEMENTS
            // ============================================
            var form = document.getElementById('masterForm');
            var submitBtn = document.getElementById('submitBtn');
            var validationStatus = document.getElementById('validationStatus');
            var statusIcon = document.getElementById('statusIcon');
            var statusText = document.getElementById('statusText');
            var filledCountEl = document.getElementById('filledCount');
            var totalCountEl = document.getElementById('totalCount');
            var draftBanner = document.getElementById('draftBanner');
            var clearDraftBtn = document.getElementById('clearDraftBtn');
            var draftStatus = document.getElementById('draftStatus');
            var formTitle = document.getElementById('formTitle');
            var formDescription = document.getElementById('formDescription');

            // UI texts
            document.getElementById("draftBannerText").textContent = t("ui.restored", "Draft restored");
            document.getElementById("clearDraftBtn").textContent = t("ui.clear", "Clear");
            document.getElementById("filledText").textContent = t("ui.filled", "Filled:");
            document.getElementById("fieldsText").textContent = t("ui.fields", "fields");
            document.getElementById("draftSavedText").textContent = t("ui.draft_saved", "Draft saved");

            // headers
            document.getElementById("hdr_personal").textContent = t("headers.personal", "Personal");
            document.getElementById("hdr_address").textContent = t("headers.address", "Address");
            document.getElementById("hdr_housing").textContent = t("headers.housing", "Housing");
            document.getElementById("hdr_bank").textContent = t("headers.bank", "Bank");
            document.getElementById("hdr_child").textContent = t("headers.child", "Child");
            document.getElementById("hdr_signature").textContent = t("headers.signature", "Signature");

            // labels
            function setLabel(id, text) {
                var el = document.getElementById(id);
                if (el) el.childNodes[0].nodeValue = text + " ";
            }
            setLabel("lbl_first_name", t("labels.first_name", "First Name"));
            setLabel("lbl_last_name", t("labels.last_name", "Last Name"));
            setLabel("lbl_birth_date", t("labels.birth_date", "Birth Date"));
            setLabel("lbl_birth_place", t("labels.birth_place", "Birth Place"));
            setLabel("lbl_nationality", t("labels.nationality", "Nationality"));
            setLabel("lbl_marital_status", t("labels.marital_status", "Marital Status"));
            setLabel("lbl_religion", t("labels.religion", "Religion"));
            setLabel("lbl_street", t("labels.street", "Street"));
            setLabel("lbl_house_number", t("labels.house_number", "House number"));
            setLabel("lbl_postal_code", t("labels.postal_code", "Postal code"));
            setLabel("lbl_city", t("labels.city", "City"));
            setLabel("lbl_previous_address", t("labels.previous_address", "Previous address"));
            setLabel("lbl_move_in_date", t("labels.move_in_date", "Move-in date"));
            setLabel("lbl_landlord_name", t("labels.landlord_name", "Landlord"));
            setLabel("lbl_iban", t("labels.iban", "IBAN"));
            setLabel("lbl_bic", t("labels.bic", "BIC"));
            setLabel("lbl_account_holder", t("labels.account_holder", "Account holder"));
            setLabel("lbl_child_first_name", t("labels.child_first_name", "Child first name"));
            setLabel("lbl_child_last_name", t("labels.child_last_name", "Child last name"));
            setLabel("lbl_child_birth_date", t("labels.child_birth_date", "Child birth date"));
            setLabel("lbl_child_birth_place", t("labels.child_birth_place", "Child birth place"));
            setLabel("lbl_child_nationality", t("labels.child_nationality", "Child nationality"));
            setLabel("lbl_signature_place", t("labels.signature_place", "Signature place"));
            setLabel("lbl_signature_date", t("labels.signature_date", "Signature date"));

            // placeholders
            document.getElementById("birth_date").placeholder = t("placeholders.birth_date", "DD.MM.YYYY");
            document.getElementById("move_in_date").placeholder = t("placeholders.move_in_date", "DD.MM.YYYY");
            document.getElementById("signature_date").placeholder = t("placeholders.signature_date", "DD.MM.YYYY");
            document.getElementById("child_birth_date").placeholder = t("placeholders.child_birth_date", "DD.MM.YYYY");
            document.getElementById("postal_code").placeholder = t("placeholders.postal_code", "12345");
            document.getElementById("iban").placeholder = t("placeholders.iban", "DE00 0000 0000 0000 0000 00");
            document.getElementById("bic").placeholder = t("placeholders.bic", "COBADEFFXXX");

            // select options (marital, religion)
            document.getElementById("opt_ms_empty").textContent = t("select.empty", "-- Select --");
            document.getElementById("opt_ms_single").textContent = t("select.ms.single", "Single");
            document.getElementById("opt_ms_married").textContent = t("select.ms.married", "Married");
            document.getElementById("opt_ms_divorced").textContent = t("select.ms.divorced", "Divorced");
            document.getElementById("opt_ms_widowed").textContent = t("select.ms.widowed", "Widowed");
            document.getElementById("opt_ms_separated").textContent = t("select.ms.separated", "Separated");
            document.getElementById("opt_ms_cu").textContent = t("select.ms.civil_union", "Civil Union");

            document.getElementById("opt_rel_empty").textContent = t("select.empty", "-- Select --");
            document.getElementById("opt_rel_none").textContent = t("select.rel.none", "None");
            document.getElementById("opt_rel_prot").textContent = t("select.rel.protestant", "Protestant");
            document.getElementById("opt_rel_cath").textContent = t("select.rel.catholic", "Catholic");
            document.getElementById("opt_rel_orth").textContent = t("select.rel.orthodox", "Orthodox");
            document.getElementById("opt_rel_mus").textContent = t("select.rel.muslim", "Muslim");
            document.getElementById("opt_rel_jew").textContent = t("select.rel.jewish", "Jewish");
            document.getElementById("opt_rel_other").textContent = t("select.rel.other", "Other");

            // Header title/description
           // Header title / description from I18N
formTitle.textContent = t("titles." + currentDocType, "Document");
formDescription.textContent = t("descriptions." + currentDocType, "");

submitBtn.textContent = t("ui.submit", "Submit");
document.title = formTitle.textContent;



            // ============================================
            // SECTION VISIBILITY
            // ============================================
            var sectionMap = {
                personal: document.getElementById("section_personal"),
                address: document.getElementById("section_address"),
                housing: document.getElementById("section_housing"),
                bank: document.getElementById("section_bank"),
                child: document.getElementById("section_child"),
                signature: document.getElementById("section_signature")
            };

            function setSectionVisible(sectionKey, visible) {
                var el = sectionMap[sectionKey];
                if (!el) return;
                if (visible) el.classList.add("visible");
                else el.classList.remove("visible");
            }

            Object.keys(sectionMap).forEach(function(k) { setSectionVisible(k, false); });
            DOCS[currentDocType].sections.forEach(function(k) { setSectionVisible(k, true); });

            // per-doc field toggles
            if (!DOCS[currentDocType].showPreviousAddress) {
                var pa = document.getElementById("previous_address");
                if (pa) pa.closest(".form-group").style.display = "none";
            }
            if (!DOCS[currentDocType].showMoveInDate) {
                var mid = document.getElementById("move_in_date");
                if (mid) mid.closest(".form-group").style.display = "none";
                // Also mark as not required if hidden
                if (mid) mid.setAttribute("data-required", "false");
            }

            // ============================================
            // ACTIVE FIELDS COLLECTION (VISIBLE SECTIONS ONLY)
            // ============================================
            var isSubmitting = false;
            var saveTimeout = null;
            var activeFields = {};
            var errorHints = {};

            function collectActiveFields() {
                activeFields = {};
                errorHints = {};

                var allControls = form.querySelectorAll('input, select, textarea');
                allControls.forEach(function(ctrl) {
                    var sectionEl = ctrl.closest(".form-section");
                    if (!sectionEl) return;
                    if (!sectionEl.classList.contains("visible")) return;

                    // if group hidden (previous_address/move_in_date for kindergeld)
                    if (ctrl.closest(".form-group") && ctrl.closest(".form-group").style.display === "none") return;

                    activeFields[ctrl.id] = ctrl;
                    var hint = document.getElementById(ctrl.id + '_error');
                    if (hint) errorHints[ctrl.id] = hint;
                });

                // total required
                var requiredCount = 0;
                Object.keys(activeFields).forEach(function(id) {
                    if (activeFields[id].getAttribute('data-required') === 'true') requiredCount++;
                });
                totalCountEl.textContent = requiredCount;
            }

            collectActiveFields();

            // ============================================
            // VALIDATION + MASKS
            // ============================================
            function isValidDate(value) {
                if (!value) return false;
                var pattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
                var match = value.match(pattern);
                if (!match) return false;
                var day = parseInt(match[1], 10);
                var month = parseInt(match[2], 10);
                var year = parseInt(match[3], 10);
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                if (year < 1900 || year > 2100) return false;
                return true;
            }

            function isValidPLZ(value) {
                return /^\d{5}$/.test(value);
            }

            function normalizeIBAN(raw) {
                return (raw || "")
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, "");
            }

            function formatIBAN(raw) {
                var v = normalizeIBAN(raw);
                var out = "";
                for (var i = 0; i < v.length; i++) {
                    if (i > 0 && i % 4 === 0) out += " ";
                    out += v[i];
                }
                return out.trim();
            }

            function isValidIBAN(value) {
                // Lightweight check: length + starts with 2 letters + 2 digits
                // (no heavy validation as requested)
                var v = normalizeIBAN(value);
                if (v.length < 15 || v.length > 34) return false;
                if (!/^[A-Z]{2}\d{2}[A-Z0-9]+$/.test(v)) return false;
                return true;
            }

            function normalizeBIC(raw) {
                return (raw || "")
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, "");
            }

            function isValidBIC(value) {
                var v = normalizeBIC(value);
                return /^[A-Z0-9]{8}([A-Z0-9]{3})?$/.test(v);
            }

            function formatDateInput(input) {
                var value = input.value.replace(/[^\d.]/g, '');
                var digits = value.replace(/\./g, '');
                var formatted = '';

                if (digits.length > 0) formatted = digits.substring(0, 2);
                if (digits.length > 2) formatted += '.' + digits.substring(2, 4);
                if (digits.length > 4) formatted += '.' + digits.substring(4, 8);

                input.value = formatted;
            }

            function validateField(fieldId, showError) {
                var input = activeFields[fieldId];
                if (!input) return true;

                var errorHint = errorHints[fieldId];
                var value = (input.value || '').trim();
                var format = input.getAttribute('data-format');
                var minLength = parseInt(input.getAttribute('data-min'), 10) || 0;
                var isRequired = input.getAttribute('data-required') === 'true';
                var isValid = true;

                input.classList.remove('valid', 'invalid');
                if (errorHint) errorHint.classList.remove('visible');

                if (!isRequired && value.length === 0) return true;

                if (isRequired && value.length === 0) {
                    if (showError) {
                        input.classList.add('invalid');
                        if (errorHint) errorHint.classList.add('visible');
                    }
                    return false;
                }

                if (format === 'date') {
                    isValid = isValidDate(value);
                } else if (format === 'plz') {
                    isValid = isValidPLZ(value);
                } else if (format === 'iban') {
                    isValid = isValidIBAN(value);
                } else if (format === 'bic') {
                    isValid = isValidBIC(value);
                } else if (minLength > 0) {
                    isValid = value.length >= minLength;
                } else if (input.tagName === 'SELECT' && isRequired) {
                    isValid = value.length > 0;
                }

                if (isValid) {
                    input.classList.add('valid');
                } else if (showError || value.length > 0) {
                    input.classList.add('invalid');
                    if (errorHint) errorHint.classList.add('visible');
                }

                return isValid;
            }

            function canSubmit() {
                var allValid = true;
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    var isRequired = input.getAttribute('data-required') === 'true';
                    if (!isRequired) return;

                    var value = (input.value || '').trim();
                    var format = input.getAttribute('data-format');
                    var minLength = parseInt(input.getAttribute('data-min'), 10) || 0;

                    if (value.length === 0) allValid = false;
                    else if (format === 'date' && !isValidDate(value)) allValid = false;
                    else if (format === 'plz' && !isValidPLZ(value)) allValid = false;
                    else if (format === 'iban' && !isValidIBAN(value)) allValid = false;
                    else if (format === 'bic' && !isValidBIC(value)) allValid = false;
                    else if (minLength > 0 && value.length < minLength) allValid = false;
                });
                return allValid;
            }

            function updateFieldCounter() {
                var count = 0;
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    if (input.getAttribute('data-required') === 'true') {
                        if ((input.value || '').trim().length > 0) count++;
                    }
                });
                filledCountEl.textContent = count;
            }

            function updateUI() {
                var ok = canSubmit();
                submitBtn.disabled = !ok || isSubmitting;

                if (ok) {
                    validationStatus.classList.remove('incomplete');
                    validationStatus.classList.add('complete');
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = t("ui.ready", "Ready");
                } else {
                    validationStatus.classList.remove('complete');
                    validationStatus.classList.add('incomplete');
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = t("ui.incomplete", "Fill required fields");
                }

                updateFieldCounter();
            }

            // ============================================
            // DRAFT STORAGE
            // ============================================
            var DRAFT_STORAGE_KEY = 'draft_' + currentDocType + '_' + currentLang;

            function saveDraft() {
                try {
                    var draftData = {};
                    var hasData = false;

                    Object.keys(activeFields).forEach(function(id) {
                        var value = (activeFields[id].value || '').trim();
                        if (value) {
                            draftData[id] = value;
                            hasData = true;
                        }
                    });

                    if (hasData) {
                        draftData._timestamp = Date.now();
                        draftData._docType = currentDocType;
                        draftData._lang = currentLang;
                        localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draftData));
                        draftStatus.classList.add('visible');
                    } else {
                        localStorage.removeItem(DRAFT_STORAGE_KEY);
                        draftStatus.classList.remove('visible');
                    }
                } catch (e) {
                    // silent
                }
            }

            function debouncedSaveDraft() {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveDraft, 500);
            }

            function loadDraft() {
                try {
                    var savedData = localStorage.getItem(DRAFT_STORAGE_KEY);
                    if (!savedData) return false;

                    var draftData = JSON.parse(savedData);
                    var restored = false;

                    Object.keys(activeFields).forEach(function(id) {
                        if (draftData[id]) {
                            activeFields[id].value = draftData[id];
                            restored = true;
                        }
                    });

                    return restored;
                } catch (e) {
                    return false;
                }
            }

            function clearDraft() {
                try { localStorage.removeItem(DRAFT_STORAGE_KEY); } catch (e) {}
                Object.keys(activeFields).forEach(function(id) {
                    activeFields[id].value = '';
                    activeFields[id].classList.remove('valid', 'invalid');
                    if (errorHints[id]) errorHints[id].classList.remove('visible');
                });
                draftBanner.classList.remove('visible', 'fade-in');
                draftStatus.classList.remove('visible');
                updateUI();
            }

            clearDraftBtn.addEventListener('click', function(e) {
                e.preventDefault();
                clearDraft();
            });

            // ============================================
            // EVENT LISTENERS
            // ============================================
            function attachEventListeners() {
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    var format = input.getAttribute('data-format');

                    input.addEventListener('input', function() {
                        if (format === 'date') {
                            formatDateInput(input);
                        } else if (format === 'plz') {
                            input.value = input.value.replace(/\D/g, '').slice(0, 5);
                        } else if (format === 'iban') {
                            var caret = input.selectionStart || 0;
                            var before = input.value;
                            input.value = formatIBAN(input.value).slice(0, 42);
                            // keep caret roughly stable
                            if (before !== input.value) {
                                input.setSelectionRange(Math.min(caret + 1, input.value.length), Math.min(caret + 1, input.value.length));
                            }
                        } else if (format === 'bic') {
                            input.value = normalizeBIC(input.value).slice(0, 11);
                        }

                        validateField(id, false);
                        updateUI();
                        debouncedSaveDraft();
                    });

                    input.addEventListener('blur', function() {
                        var value = (input.value || '').trim();
                        if (value.length > 0 || input.getAttribute('data-required') === 'true') {
                            validateField(id, true);
                        }
                    });

                    if (input.tagName === 'SELECT') {
                        input.addEventListener('change', function() {
                            validateField(id, false);
                            updateUI();
                            debouncedSaveDraft();
                        });
                    }
                });
            }

            attachEventListeners();

            // ============================================
            // SUBMIT ‚Üí tg.sendData(JSON.stringify(payload))
            // FORMAT STRICT:
            // { doc_type: currentDocType, user_answers: userAnswers }
            // ============================================
     submitBtn.addEventListener('click', function (e) {
    e.preventDefault();
    if (isSubmitting) return;

    // Final validation
    var allValid = true;
    Object.keys(activeFields).forEach(function (id) {
        if (!validateField(id, true)) allValid = false;
    });

    if (!allValid) {
        submitBtn.classList.add('shake');
        setTimeout(function () {
            submitBtn.classList.remove('shake');
        }, 400);
        return;
    }

    isSubmitting = true;
    submitBtn.textContent = t("ui.generating", "Generating...");
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    // Collect answers
    var userAnswers = {};
    Object.keys(activeFields).forEach(function (id) {
        var el = activeFields[id];
        var v = (el.value || '').trim();
        if (!v) return;

        if (el.name === "iban") v = normalizeIBAN(v);
        if (el.name === "bic") v = normalizeBIC(v);

        userAnswers[el.name] = v;
    });

    var payload = {
        doc_type: currentDocType,
        user_answers: userAnswers
    };

    console.log("üöÄ SEND TO TELEGRAM:", payload);

    // ‚ùó CRITICAL FIX: DO NOT CLOSE WEBAPP
    if (window.Telegram && Telegram.WebApp) {
        try {
            Telegram.WebApp.sendData(JSON.stringify(payload));
        } catch (e) {
            console.error("sendData failed", e);
        }
    } else {
        console.error("Telegram WebApp not found");
    }

    // ‚ùó DO NOT CALL tg.close()
});


    // Collect answers by NAME (contract keys)
    var userAnswers = {};
    Object.keys(activeFields).forEach(function(id) {
        var el = activeFields[id];
        var v = (el.value || '').trim();
        if (!v) return;

        if (el.name === "iban") v = normalizeIBAN(v);
        if (el.name === "bic") v = normalizeBIC(v);

        userAnswers[el.name] = v;
    });

    var payload = {
        doc_type: currentDocType,
        user_answers: userAnswers
    };

    // üîç DEBUG ‚Äî —â–æ–± —Ç–∏ –±–∞—á–∏–≤ —â–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è
    console.log("üöÄ PAYLOAD TO TELEGRAM:");
    console.log(payload);
    console.log(JSON.stringify(payload));

    // Clear draft
    try { localStorage.removeItem(DRAFT_STORAGE_KEY); } catch (e) {}

    if (tg && tg.sendData) {
        try {
           tg.sendData(JSON.stringify(payload));
console.log("üì§ Payload sent to Telegram:", payload);

setTimeout(function() {
    if (tg.close) {
        console.log("üîí Closing WebApp to deliver data to bot");
        tg.close();
    }
}, 300);


            // ‚ùå –ù–ï –∑–∞–∫—Ä–∏–≤–∞—î–º–æ WebApp —Ç—É—Ç
            // tg.close() –º–∞—î –≤–∏–∫–ª–∏–∫–∞—Ç–∏—Å—å –±–æ—Ç–æ–º –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è

        } catch (err) {
            console.error("‚ùå tg.sendData failed:", err);
            isSubmitting = false;
            submitBtn.textContent = t("ui.submit", "Submit");
            submitBtn.classList.remove('loading');
            updateUI();
        }
    } else {
        console.warn("‚ö†Ô∏è WebApp not opened via Telegram");

        statusIcon.textContent = '‚ö†Ô∏è';
        statusText.textContent = 'WebApp not connected to Telegram';
        validationStatus.classList.remove('incomplete');
        validationStatus.classList.add('complete');

        setTimeout(function() {
            isSubmitting = false;
            submitBtn.textContent = t("ui.submit", "Submit");
            submitBtn.classList.remove('loading');
            updateUI();
        }, 1000);
    }
});

            // ============================================
            // BACK BUTTON (no cancelled send)
            // ============================================
            if (tg && tg.BackButton) {
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    if (tg.close) tg.close();
                });
            }

            // ============================================
            // INIT + DRAFT RESTORE
            // ============================================
            submitBtn.textContent = t("ui.submit", "Submit");

            // Hide address-only fields for kindergeld
            if (currentDocType === "kindergeld") {
                var paGroup = document.getElementById("previous_address").closest(".form-group");
                if (paGroup) paGroup.style.display = "none";
                var midGroup = document.getElementById("move_in_date").closest(".form-group");
                if (midGroup) midGroup.style.display = "none";
            }

            // Re-collect after toggles
            collectActiveFields();
            attachEventListeners(); // safe to call again? avoid duplicates by not calling twice for same nodes
            // To avoid duplicates, we won't reattach. Instead: (simple) skip second attach by no-op.
            // Keeping stable: do nothing.

            var draftRestored = loadDraft();
            if (draftRestored) {
                draftBanner.classList.add('visible', 'fade-in');
                Object.keys(activeFields).forEach(function(id) { validateField(id, false); });
            }

            updateUI();

        })();
    </script>
</body>
</html>














