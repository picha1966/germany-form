<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1a1a1a);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #3390ec);
            --button-color: var(--tg-theme-button-color, #4caf50);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);
            --border-color: #e0e0e0;
            --border-focus: var(--link-color);
            --error-color: #e53935;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --button-disabled: #cccccc;
            --input-bg: var(--secondary-bg);
        }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 140px;
        }
        .header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 14px;
            color: var(--hint-color);
        }
        .section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .section-header:first-of-type {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-color);
        }
        .form-group label .required {
            color: var(--error-color);
            margin-left: 2px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
            cursor: pointer;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.15);
        }
        .form-group input.valid,
        .form-group select.valid {
            border-color: var(--success-color);
        }
        .form-group input.invalid,
        .form-group select.invalid {
            border-color: var(--error-color);
        }
        .error-hint {
            font-size: 12px;
            color: var(--error-color);
            margin-top: 4px;
            min-height: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .error-hint.visible {
            visibility: visible;
            opacity: 1;
        }
        .validation-status {
            background-color: var(--input-bg);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .validation-status.incomplete {
            border-left: 3px solid var(--error-color);
        }
        .validation-status.complete {
            border-left: 3px solid var(--success-color);
        }
        .validation-status .icon {
            margin-right: 8px;
            font-size: 16px;
        }
        .form-section {
            display: none;
        }
        .form-section.visible {
            display: block;
        }
        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(transparent, var(--bg-color) 30%);
            z-index: 100;
        }
        .submit-btn {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: block;
            padding: 16px 24px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .submit-btn:disabled {
            background-color: var(--button-disabled);
            color: #888888;
            cursor: not-allowed;
        }
        .submit-btn:not(:disabled) {
            background-color: var(--button-color);
            color: var(--button-text-color);
        }
        .submit-btn:not(:disabled):active {
            transform: scale(0.98);
        }
        .submit-btn.loading {
            background-color: var(--hint-color);
            pointer-events: none;
        }
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--hint-color);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="formTitle">Document Form</h1>
            <p id="formDescription">Fill in the required information</p>
        </div>

        <div class="validation-status incomplete" id="validationStatus">
            <span class="icon" id="statusIcon">‚ö†Ô∏è</span>
            <span id="statusText">Fill required fields</span>
        </div>

        <form id="masterForm" autocomplete="off" novalidate>
            <!-- PERSONAL SECTION -->
            <div class="form-section visible" id="section_personal">
                <div class="section-header" data-i18n="section.personal">Personal Data</div>

                <div class="form-group">
                    <label for="first_name">
                        <span data-i18n="label.first_name">First Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="first_name" name="first_name" 
                           data-i18n-placeholder="placeholder.first_name"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_first_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="last_name">
                        <span data-i18n="label.last_name">Last Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="last_name" name="last_name"
                           data-i18n-placeholder="placeholder.last_name"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_last_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="birth_date">
                        <span data-i18n="label.birth_date">Birth Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="birth_date" name="birth_date" 
                           data-i18n-placeholder="placeholder.birth_date"
                           inputmode="numeric" maxlength="10" 
                           data-section="personal" data-required="true" data-format="date">
                    <div class="error-hint" id="err_birth_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>

                <div class="form-group">
                    <label for="birth_place">
                        <span data-i18n="label.birth_place">Birth Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="birth_place" name="birth_place"
                           data-i18n-placeholder="placeholder.birth_place"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_birth_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="nationality">
                        <span data-i18n="label.nationality">Nationality</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="nationality" name="nationality"
                           data-i18n-placeholder="placeholder.nationality"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_nationality" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="marital_status">
                        <span data-i18n="label.marital_status">Marital Status</span>
                        <span class="required">*</span>
                    </label>
                    <select id="marital_status" name="marital_status" data-section="personal" data-required="true">
                        <option value="" data-i18n="select.empty">-- Select --</option>
                        <option value="single" data-i18n="select.marital.single">Single</option>
                        <option value="married" data-i18n="select.marital.married">Married</option>
                        <option value="divorced" data-i18n="select.marital.divorced">Divorced</option>
                        <option value="widowed" data-i18n="select.marital.widowed">Widowed</option>
                        <option value="separated" data-i18n="select.marital.separated">Separated</option>
                        <option value="civil_union" data-i18n="select.marital.civil_union">Civil Union</option>
                    </select>
                    <div class="error-hint" id="err_marital_status" data-i18n="error.select">Please select</div>
                </div>

                <div class="form-group">
                    <label for="religion">
                        <span data-i18n="label.religion">Religion</span>
                        <span class="required">*</span>
                    </label>
                    <select id="religion" name="religion" data-section="personal" data-required="true">
                        <option value="" data-i18n="select.empty">-- Select --</option>
                        <option value="none" data-i18n="select.religion.none">None</option>
                        <option value="protestant" data-i18n="select.religion.protestant">Protestant</option>
                        <option value="catholic" data-i18n="select.religion.catholic">Catholic</option>
                        <option value="orthodox" data-i18n="select.religion.orthodox">Orthodox</option>
                        <option value="muslim" data-i18n="select.religion.muslim">Muslim</option>
                        <option value="jewish" data-i18n="select.religion.jewish">Jewish</option>
                        <option value="other" data-i18n="select.religion.other">Other</option>
                    </select>
                    <div class="error-hint" id="err_religion" data-i18n="error.select">Please select</div>
                </div>
            </div>

            <!-- ADDRESS SECTION -->
            <div class="form-section" id="section_address">
                <div class="section-header" data-i18n="section.address">Address</div>

                <div class="form-group">
                    <label for="street">
                        <span data-i18n="label.street">Street</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="street" name="street"
                           data-i18n-placeholder="placeholder.street"
                           data-section="address" data-required="true" data-min="2">
                    <div class="error-hint" id="err_street" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="house_number">
                        <span data-i18n="label.house_number">House Number</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="house_number" name="house_number"
                           data-i18n-placeholder="placeholder.house_number"
                           data-section="address" data-required="true" data-min="1">
                    <div class="error-hint" id="err_house_number" data-i18n="error.required">Required</div>
                </div>

                <div class="form-group">
                    <label for="postal_code">
                        <span data-i18n="label.postal_code">Postal Code</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="postal_code" name="postal_code"
                           data-i18n-placeholder="placeholder.postal_code"
                           inputmode="numeric" maxlength="5"
                           data-section="address" data-required="true" data-format="plz">
                    <div class="error-hint" id="err_postal_code" data-i18n="error.plz">Exactly 5 digits</div>
                </div>

                <div class="form-group">
                    <label for="city">
                        <span data-i18n="label.city">City</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="city" name="city"
                           data-i18n-placeholder="placeholder.city"
                           data-section="address" data-required="true" data-min="2">
                    <div class="error-hint" id="err_city" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group" id="group_previous_address">
                    <label for="previous_address">
                        <span data-i18n="label.previous_address">Previous Address</span>
                    </label>
                    <input type="text" id="previous_address" name="previous_address"
                           data-i18n-placeholder="placeholder.previous_address"
                           data-section="address" data-required="false">
                    <div class="error-hint" id="err_previous_address"></div>
                </div>

                <div class="form-group" id="group_move_in_date">
                    <label for="move_in_date">
                        <span data-i18n="label.move_in_date">Move-in Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="move_in_date" name="move_in_date"
                           data-i18n-placeholder="placeholder.move_in_date"
                           inputmode="numeric" maxlength="10"
                           data-section="address" data-required="true" data-format="date">
                    <div class="error-hint" id="err_move_in_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>
            </div>

            <!-- HOUSING SECTION -->
            <div class="form-section" id="section_housing">
                <div class="section-header" data-i18n="section.housing">Housing</div>

                <div class="form-group">
                    <label for="landlord_name">
                        <span data-i18n="label.landlord_name">Landlord Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="landlord_name" name="landlord_name"
                           data-i18n-placeholder="placeholder.landlord_name"
                           data-section="housing" data-required="true" data-min="2">
                    <div class="error-hint" id="err_landlord_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- BANK SECTION -->
            <div class="form-section" id="section_bank">
                <div class="section-header" data-i18n="section.bank">Bank Details</div>

                <div class="form-group">
                    <label for="iban">
                        <span data-i18n="label.iban">IBAN</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="iban" name="iban"
                           data-i18n-placeholder="placeholder.iban"
                           inputmode="text" maxlength="42"
                           data-section="bank" data-required="true" data-format="iban">
                    <div class="error-hint" id="err_iban" data-i18n="error.iban">Enter valid IBAN</div>
                </div>

                <div class="form-group">
                    <label for="bic">
                        <span data-i18n="label.bic">BIC</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="bic" name="bic"
                           data-i18n-placeholder="placeholder.bic"
                           inputmode="text" maxlength="11"
                           data-section="bank" data-required="true" data-format="bic">
                    <div class="error-hint" id="err_bic" data-i18n="error.bic">8-11 characters</div>
                </div>

                <div class="form-group">
                    <label for="account_holder">
                        <span data-i18n="label.account_holder">Account Holder</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="account_holder" name="account_holder"
                           data-i18n-placeholder="placeholder.account_holder"
                           data-section="bank" data-required="true" data-min="2">
                    <div class="error-hint" id="err_account_holder" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- CHILD SECTION -->
            <div class="form-section" id="section_child">
                <div class="section-header" data-i18n="section.child">Child Information</div>

                <div class="form-group">
                    <label for="child_first_name">
                        <span data-i18n="label.child_first_name">Child First Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_first_name" name="child_first_name"
                           data-i18n-placeholder="placeholder.child_first_name"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_first_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_last_name">
                        <span data-i18n="label.child_last_name">Child Last Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_last_name" name="child_last_name"
                           data-i18n-placeholder="placeholder.child_last_name"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_last_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_birth_date">
                        <span data-i18n="label.child_birth_date">Child Birth Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_birth_date" name="child_birth_date"
                           data-i18n-placeholder="placeholder.child_birth_date"
                           inputmode="numeric" maxlength="10"
                           data-section="child" data-required="true" data-format="date">
                    <div class="error-hint" id="err_child_birth_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>

                <div class="form-group">
                    <label for="child_birth_place">
                        <span data-i18n="label.child_birth_place">Child Birth Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_birth_place" name="child_birth_place"
                           data-i18n-placeholder="placeholder.child_birth_place"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_birth_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_nationality">
                        <span data-i18n="label.child_nationality">Child Nationality</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_nationality" name="child_nationality"
                           data-i18n-placeholder="placeholder.child_nationality"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_nationality" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- SIGNATURE SECTION -->
            <div class="form-section" id="section_signature">
                <div class="section-header" data-i18n="section.signature">Signature</div>

                <div class="form-group">
                    <label for="signature_place">
                        <span data-i18n="label.signature_place">Signature Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="signature_place" name="signature_place"
                           data-i18n-placeholder="placeholder.signature_place"
                           data-section="signature" data-required="true" data-min="2">
                    <div class="error-hint" id="err_signature_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="signature_date">
                        <span data-i18n="label.signature_date">Signature Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="signature_date" name="signature_date"
                           data-i18n-placeholder="placeholder.signature_date"
                           inputmode="numeric" maxlength="10"
                           data-section="signature" data-required="true" data-format="date">
                    <div class="error-hint" id="err_signature_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>
            </div>
        </form>

        <div class="form-footer">
            <div class="field-counter">
                <span data-i18n="ui.filled">Filled:</span>
                <span id="filledCount">0</span> /
                <span id="totalCount">0</span>
                <span data-i18n="ui.fields">fields</span>
            </div>
        </div>
    </div>

    <div class="submit-container">
        <button type="button" class="submit-btn" id="submitBtn" disabled data-i18n="ui.submit">Submit</button>
    </div>

    <script>
    (function() {
        'use strict';

        console.log('üîÑ [INIT] Script starting...');

        // ========================================
        // 1. –ü–ï–†–ï–í–Ü–†–ö–ê TELEGRAM WEBAPP (3 —Å–µ–∫—É–Ω–¥–∏ —Ç–∞–π–º–∞—É—Ç)
        // ========================================
        let tg = null;
        let tgReady = false;
        let initAttempts = 0;
        const MAX_INIT_ATTEMPTS = 30; // 30 * 100ms = 3 seconds

        function initTelegram() {
            initAttempts++;
            console.log(`‚è≥ [INIT] Attempt ${initAttempts}/${MAX_INIT_ATTEMPTS} - Checking Telegram API...`);

            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tgReady = true;
                
                console.log('‚úÖ [INIT] Telegram WebApp loaded successfully!');
                console.log('   Platform:', tg.platform);
                console.log('   Version:', tg.version);
                console.log('   sendData:', typeof tg.sendData);
                
                return true;
            }

            if (initAttempts >= MAX_INIT_ATTEMPTS) {
                console.error('‚ùå [INIT] Telegram WebApp failed to load after 3 seconds');
                
                document.body.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;text-align:center;font-family:sans-serif;background:#f5f5f5;">
                        <div style="background:white;border-radius:16px;padding:32px;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size:48px;margin-bottom:16px;">‚ùå</div>
                            <h2 style="font-size:20px;margin-bottom:12px;color:#e53935;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h2>
                            <p style="font-size:14px;color:#666;line-height:1.5;margin-bottom:20px;">
                                WebApp –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 3 —Å–µ–∫—É–Ω–¥.<br><br>
                                <strong>–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:</strong><br>
                                ‚Ä¢ –¶—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –Ω–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç<br>
                                ‚Ä¢ –ü–æ–≤—ñ–ª—å–Ω–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è<br>
                                ‚Ä¢ –ó–∞—Å—Ç–∞—Ä—ñ–ª–∞ –≤–µ—Ä—Å—ñ—è Telegram<br><br>
                                <strong>–†—ñ—à–µ–Ω–Ω—è:</strong><br>
                                1. –ó–∞–∫—Ä–∏–π—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É<br>
                                2. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –±–æ—Ç –≤ Telegram<br>
                                3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É"
                            </p>
                            <button onclick="window.close()" style="background:#3390ec;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">
                                –ó–∞–∫—Ä–∏—Ç–∏
                            </button>
                        </div>
                    </div>
                `;
                return false;
            }

            setTimeout(initTelegram, 100);
            return false;
        }

        initTelegram();

        // ========================================
        // TRANSLATIONS
        // ========================================
        const TRANSLATIONS = {
            ua: {
                title: { anmeldung: 'Anmeldung (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)', kindergeld: 'Kindergeld (–î–æ–ø–æ–º–æ–≥–∞ –Ω–∞ –¥—ñ—Ç–µ–π)' },
                description: { anmeldung: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –º—ñ—Å—Ü–µ–º –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è', kindergeld: '–ó–∞—è–≤–∞ –Ω–∞ –¥–æ–ø–æ–º–æ–≥—É –Ω–∞ –¥—ñ—Ç–µ–π' },
                section: {
                    personal: '–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ',
                    address: '–ê–¥—Ä–µ—Å–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è',
                    housing: '–ñ–∏—Ç–ª–æ–≤—ñ –¥–∞–Ω—ñ',
                    bank: '–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏',
                    child: '–î–∞–Ω—ñ –¥–∏—Ç–∏–Ω–∏',
                    signature: '–ü—ñ–¥–ø–∏—Å'
                },
                label: {
                    first_name: "–Ü–º'—è",
                    last_name: '–ü—Ä—ñ–∑–≤–∏—â–µ',
                    birth_date: '–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è',
                    birth_place: '–ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è',
                    nationality: '–ì—Ä–æ–º–∞–¥—è–Ω—Å—Ç–≤–æ',
                    marital_status: '–°—ñ–º–µ–π–Ω–∏–π —Å—Ç–∞–Ω',
                    religion: '–í—ñ—Ä–æ—Å–ø–æ–≤—ñ–¥–∞–Ω–Ω—è',
                    street: '–í—É–ª–∏—Ü—è',
                    house_number: '–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É',
                    postal_code: '–ü–æ—à—Ç–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å (PLZ)',
                    city: '–ú—ñ—Å—Ç–æ',
                    previous_address: '–ü–æ–ø–µ—Ä–µ–¥–Ω—è –∞–¥—Ä–µ—Å–∞',
                    move_in_date: '–î–∞—Ç–∞ –∑–∞—ó–∑–¥—É',
                    landlord_name: '–ü–Ü–ë –æ—Ä–µ–Ω–¥–æ–¥–∞–≤—Ü—è',
                    iban: 'IBAN',
                    bic: 'BIC',
                    account_holder: '–í–ª–∞—Å–Ω–∏–∫ —Ä–∞—Ö—É–Ω–∫—É',
                    child_first_name: "–Ü–º'—è –¥–∏—Ç–∏–Ω–∏",
                    child_last_name: '–ü—Ä—ñ–∑–≤–∏—â–µ –¥–∏—Ç–∏–Ω–∏',
                    child_birth_date: '–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏',
                    child_birth_place: '–ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏',
                    child_nationality: '–ì—Ä–æ–º–∞–¥—è–Ω—Å—Ç–≤–æ –¥–∏—Ç–∏–Ω–∏',
                    signature_place: '–ú—ñ—Å—Ç–æ (–¥–ª—è –ø—ñ–¥–ø–∏—Å—É)',
                    signature_date: '–î–∞—Ç–∞ (–¥–ª—è –ø—ñ–¥–ø–∏—Å—É)'
                },
                placeholder: {
                    first_name: "–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è",
                    last_name: '–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø—Ä—ñ–∑–≤–∏—â–µ',
                    birth_date: '–î–î.–ú–ú.–†–†–†–†',
                    birth_place: '–Ω–∞–ø—Ä., –ö–∏—ó–≤',
                    nationality: '–Ω–∞–ø—Ä., ukrainisch',
                    street: '–Ω–∞–ø—Ä., Hauptstra√üe',
                    house_number: '–Ω–∞–ø—Ä., 15a',
                    postal_code: '12345',
                    city: '–Ω–∞–ø—Ä., Berlin',
                    previous_address: '–Ω–∞–ø—Ä., Alte Stra√üe 15, 10117 Berlin',
                    move_in_date: '–î–î.–ú–ú.–†–†–†–†',
                    landlord_name: "–ü–æ–≤–Ω–µ —ñ–º'—è –æ—Ä–µ–Ω–¥–æ–¥–∞–≤—Ü—è",
                    iban: 'DE00 0000 0000 0000 0000 00',
                    bic: 'COBADEFFXXX',
                    account_holder: '–Ω–∞–ø—Ä., Max Mustermann',
                    child_first_name: "–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –¥–∏—Ç–∏–Ω–∏",
                    child_last_name: '–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ –¥–∏—Ç–∏–Ω–∏',
                    child_birth_date: '–î–î.–ú–ú.–†–†–†–†',
                    child_birth_place: '–Ω–∞–ø—Ä., Berlin',
                    child_nationality: '–Ω–∞–ø—Ä., deutsch',
                    signature_place: '–Ω–∞–ø—Ä., Berlin',
                    signature_date: '–î–î.–ú–ú.–†–†–†–†'
                },
                error: {
                    min2: '–ú—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏',
                    required: "–û–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ",
                    date: '–§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–†–†–†–†',
                    plz: '–†—ñ–≤–Ω–æ 5 —Ü–∏—Ñ—Ä',
                    iban: '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π IBAN',
                    bic: '8-11 —Å–∏–º–≤–æ–ª—ñ–≤',
                    select: '–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è',
                    cyrillic: '–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏'
                },
                select: {
                    empty: '-- –û–±–µ—Ä—ñ—Ç—å --',
                    marital: {
                        single: '–ù–µ–æ–¥—Ä—É–∂–µ–Ω–∏–π/–Ω–µ–æ–¥—Ä—É–∂–µ–Ω–∞',
                        married: '–û–¥—Ä—É–∂–µ–Ω–∏–π/–∑–∞–º—ñ–∂–Ω—è',
                        divorced: '–†–æ–∑–ª—É—á–µ–Ω–∏–π/—Ä–æ–∑–ª—É—á–µ–Ω–∞',
                        widowed: '–í–¥—ñ–≤–µ—Ü—å/–≤–¥–æ–≤–∞',
                        separated: '–û–∫—Ä–µ–º–æ –ø—Ä–æ–∂–∏–≤–∞—î',
                        civil_union: '–¶–∏–≤—ñ–ª—å–Ω–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ'
                    },
                    religion: {
                        none: '–ù–µ–º–∞—î',
                        protestant: '–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç—Å—Ç–≤–æ',
                        catholic: '–ö–∞—Ç–æ–ª–∏—Ü–∏–∑–º',
                        orthodox: '–ü—Ä–∞–≤–æ—Å–ª–∞–≤\'—è',
                        muslim: '–Ü—Å–ª–∞–º',
                        jewish: '–Ü—É–¥–∞—ó–∑–º',
                        other: '–Ü–Ω—à–µ'
                    }
                },
                ui: {
                    incomplete: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è",
                    ready: '–§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏',
                    filled: '–ó–∞–ø–æ–≤–Ω–µ–Ω–æ:',
                    fields: '–ø–æ–ª—ñ–≤',
                    submit: '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ PDF',
                    sending: '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ...',
                    error_empty: '–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è!',
                    error_validation: '–î–µ—è–∫—ñ –ø–æ–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'
                }
            }
        };

        // ========================================
        // URL PARAMS
        // ========================================
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            let docType = (params.get('doc_type') || 'anmeldung').toLowerCase();
            let lang = (params.get('lang') || 'ua').toLowerCase();
            
            if (lang === 'uk') lang = 'ua';
            
            const supported = ['ua'];
            if (!supported.includes(lang)) lang = 'ua';
            
            return { docType, lang };
        }

        const PARAMS = getUrlParams();
        const currentDocType = PARAMS.docType;
        const currentLang = PARAMS.lang;
        
        console.log('üìÑ [CONFIG] Document:', currentDocType);
        console.log('üåç [CONFIG] Language:', currentLang);

        // ========================================
        // TRANSLATION FUNCTION
        // ========================================
        function t(path) {
            const keys = path.split('.');
            let obj = TRANSLATIONS[currentLang] || TRANSLATIONS.ua;
            
            for (let i = 0; i < keys.length; i++) {
                if (!obj || typeof obj !== 'object') return path;
                obj = obj[keys[i]];
            }
            
            return obj || path;
        }

        // ========================================
        // APPLY TRANSLATIONS
        // ========================================
        function applyTranslations() {
            document.getElementById('formTitle').textContent = t('title.' + currentDocType);
            document.getElementById('formDescription').textContent = t('description.' + currentDocType);
            document.title = t('title.' + currentDocType);
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t(el.getAttribute('data-i18n'));
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
            });
        }

        // ========================================
        // DOC TYPE CONFIG
        // ========================================
        const DOCS = {
            anmeldung: { sections: ['personal', 'address', 'housing', 'signature'] },
            kindergeld: { sections: ['personal', 'address', 'bank', 'child', 'signature'] }
        };

        // ========================================
        // SECTIONS VISIBILITY
        // ========================================
        const sectionMap = {
            personal: document.getElementById('section_personal'),
            address: document.getElementById('section_address'),
            housing: document.getElementById('section_housing'),
            bank: document.getElementById('section_bank'),
            child: document.getElementById('section_child'),
            signature: document.getElementById('section_signature')
        };

        Object.keys(sectionMap).forEach(k => {
            if (sectionMap[k]) sectionMap[k].classList.remove('visible');
        });
        
        DOCS[currentDocType].sections.forEach(k => {
            if (sectionMap[k]) sectionMap[k].classList.add('visible');
        });

        if (currentDocType === 'kindergeld') {
            const pg = document.getElementById('group_previous_address');
            const mg = document.getElementById('group_move_in_date');
            if (pg) pg.style.display = 'none';
            if (mg) mg.style.display = 'none';
        }

        // ========================================
        // COLLECT ACTIVE FIELDS
        // ========================================
        const form = document.getElementById('masterForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const validationStatus = document.getElementById('validationStatus');
        const filledCountEl = document.getElementById('filledCount');
        const totalCountEl = document.getElementById('totalCount');
        
        let activeFields = {};
        let errorHints = {};
        let isSubmitting = false;

        function collectActiveFields() {
            activeFields = {};
            errorHints = {};
            
            const allControls = form.querySelectorAll('input, select');
            allControls.forEach(ctrl => {
                const section = ctrl.closest('.form-section');
                if (!section || !section.classList.contains('visible')) return;
                
                const group = ctrl.closest('.form-group');
                if (group && group.style.display === 'none') return;
                
                activeFields[ctrl.id] = ctrl;
                const hint = document.getElementById('err_' + ctrl.id);
                if (hint) errorHints[ctrl.id] = hint;
            });
            
            let requiredCount = 0;
            Object.keys(activeFields).forEach(id => {
                if (activeFields[id].getAttribute('data-required') === 'true') requiredCount++;
            });
            
            totalCountEl.textContent = requiredCount;
        }

        collectActiveFields();

        // ========================================
        // VALIDATION FUNCTIONS
        // ========================================
        function isValidDate(value) {
            if (!value) return false;
            const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
            if (!m) return false;
            const d = parseInt(m[1], 10), mo = parseInt(m[2], 10), y = parseInt(m[3], 10);
            return mo >= 1 && mo <= 12 && d >= 1 && d <= 31 && y >= 1900 && y <= 2100;
        }

        function formatDateInput(input) {
            const digits = input.value.replace(/[^\d]/g, '');
            let formatted = '';
            if (digits.length > 0) formatted = digits.substring(0, 2);
            if (digits.length > 2) formatted += '.' + digits.substring(2, 4);
            if (digits.length > 4) formatted += '.' + digits.substring(4, 8);
            input.value = formatted;
        }

        function isValidPLZ(value) {
            return /^\d{5}$/.test(value);
        }

        function normalizeIBAN(raw) {
            return (raw || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        function formatIBAN(raw) {
            const v = normalizeIBAN(raw);
            let formatted = '';
            for (let i = 0; i < v.length; i++) {
                if (i > 0 && i % 4 === 0) formatted += ' ';
                formatted += v[i];
            }
            return formatted.trim();
        }

        function isValidIBAN(value) {
            const v = normalizeIBAN(value);
            return v.length >= 15 && v.length <= 34 && /^[A-Z]{2}\d{2}[A-Z0-9]+$/.test(v);
        }

        function normalizeBIC(raw) {
            return (raw || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        function isValidBIC(value) {
            const v = normalizeBIC(value);
            return /^[A-Z0-9]{8}([A-Z0-9]{3})?$/.test(v);
        }

        function hasCyrillic(text) {
            return /[–∞-—è—ë–ê-–Ø–Å]/.test(text);
        }

        function validateField(fieldId, showError) {
            const input = activeFields[fieldId];
            if (!input) return true;
            
            const hint = errorHints[fieldId];
            const value = (input.value || '').trim();
            const format = input.getAttribute('data-format');
            const minLen = parseInt(input.getAttribute('data-min'), 10) || 0;
            const isReq = input.getAttribute('data-required') === 'true';
            let valid = true;

            input.classList.remove('valid', 'invalid');
            if (hint) hint.classList.remove('visible');

            if (!isReq && !value) return true;
            if (isReq && !value) {
                if (showError) {
                    input.classList.add('invalid');
                    if (hint) {
                        hint.textContent = t('error.required');
                        hint.classList.add('visible');
                    }
                }
                return false;
            }

            if (currentLang !== 'ua' && ['first_name', 'last_name', 'nationality', 'birth_place', 'city', 'street'].includes(fieldId)) {
                if (hasCyrillic(value)) {
                    if (hint) {
                        hint.textContent = t('error.cyrillic');
                        hint.classList.add('visible');
                    }
                    input.classList.add('invalid');
                    return false;
                }
            }

            if (format === 'date') valid = isValidDate(value);
            else if (format === 'plz') valid = isValidPLZ(value);
            else if (format === 'iban') valid = isValidIBAN(value);
            else if (format === 'bic') valid = isValidBIC(value);
            else if (minLen > 0) valid = value.length >= minLen;
            else if (input.tagName === 'SELECT' && isReq) valid = value.length > 0;

            if (valid) {
                input.classList.add('valid');
            } else if (showError || value) {
                input.classList.add('invalid');
                if (hint) hint.classList.add('visible');
            }
            
            return valid;
        }

        function canSubmit() {
            let allValid = true;
            Object.keys(activeFields).forEach(id => {
                const inp = activeFields[id];
                if (inp.getAttribute('data-required') !== 'true') return;
                
                const v = (inp.value || '').trim();
                if (!v) {
                    allValid = false;
                    return;
                }
                
                const fmt = inp.getAttribute('data-format');
                const minL = parseInt(inp.getAttribute('data-min'), 10) || 0;
                
                if (fmt === 'date' && !isValidDate(v)) allValid = false;
                else if (fmt === 'plz' && !isValidPLZ(v)) allValid = false;
                else if (fmt === 'iban' && !isValidIBAN(v)) allValid = false;
                else if (fmt === 'bic' && !isValidBIC(v)) allValid = false;
                else if (minL > 0 && v.length < minL) allValid = false;
                
                if (currentLang !== 'ua' && ['first_name', 'last_name', 'nationality', 'birth_place', 'city', 'street'].includes(id)) {
                    if (hasCyrillic(v)) allValid = false;
                }
            });
            return allValid;
        }

        function updateFieldCounter() {
            let count = 0;
            Object.keys(activeFields).forEach(id => {
                if (activeFields[id].getAttribute('data-required') === 'true' && (activeFields[id].value || '').trim()) {
                    count++;
                }
            });
            filledCountEl.textContent = count;
        }

        function updateUI() {
            const ready = canSubmit();
            submitBtn.disabled = !ready || isSubmitting;
            
            if (ready) {
                validationStatus.classList.remove('incomplete');
                validationStatus.classList.add('complete');
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = t('ui.ready');
            } else {
                validationStatus.classList.remove('complete');
                validationStatus.classList.add('incomplete');
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = t('ui.incomplete');
            }
            
            updateFieldCounter();
        }

        // ========================================
        // INPUT EVENTS
        // ========================================
        Object.keys(activeFields).forEach(id => {
            const inp = activeFields[id];
            const fmt = inp.getAttribute('data-format');

            inp.addEventListener('input', () => {
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø
                console.log(`üìù [INPUT] Field changed: ${id}`);
                
                // 5. –ù–û–†–ú–ê–õ–Ü–ó–ê–¶–Ü–Ø –î–ê–ù–ò–• (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤)
                if (fmt === 'date') formatDateInput(inp);
                else if (fmt === 'plz') inp.value = inp.value.replace(/\D/g, '').slice(0, 5);
                else if (fmt === 'iban') {
                    console.log(`üîÑ [NORMALIZE] IBAN before: "${inp.value}"`);
                    inp.value = formatIBAN(inp.value).slice(0, 42);
                    console.log(`üîÑ [NORMALIZE] IBAN after: "${inp.value}"`);
                }
                else if (fmt === 'bic') {
                    console.log(`üîÑ [NORMALIZE] BIC before: "${inp.value}"`);
                    inp.value = normalizeBIC(inp.value).slice(0, 11);
                    console.log(`üîÑ [NORMALIZE] BIC after: "${inp.value}"`);
                }
                
                validateField(id, false);
                updateUI();
            });

            inp.addEventListener('blur', () => {
                const v = (inp.value || '').trim();
                if (v || inp.getAttribute('data-required') === 'true') {
                    validateField(id, true);
                }
            });

            if (inp.tagName === 'SELECT') {
                inp.addEventListener('change', () => {
                    validateField(id, false);
                    updateUI();
                });
            }
        });

        // ========================================
        // 2. SUBMIT HANDLER –ó try...catch
        // ========================================
        function submitForm(e) {
            if (e) e.preventDefault();
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöÄ [SUBMIT] BUTTON CLICKED');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // 4. –°–¢–Ü–ô–ö–Ü–°–¢–¨ –î–û –ü–û–ú–ò–õ–û–ö - try...catch –Ω–∞–≤–∫–æ–ª–æ –≤—Å—ñ—î—ó –ª–æ–≥—ñ–∫–∏
            try {
                if (isSubmitting) {
                    console.log('‚è∏Ô∏è [SUBMIT] Already submitting');
                    return;
                }
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –í–∞–ª—ñ–¥–∞—Ü—ñ—è
                console.log('‚úÖ [STAGE 1] Validation...');
                
                let allValid = true;
                let emptyFields = [];
                
                Object.keys(activeFields).forEach(id => {
                    const field = activeFields[id];
                    const isValid = validateField(id, true);
                    
                    if (!isValid) {
                        allValid = false;
                        if (field.getAttribute('data-required') === 'true' && !(field.value || '').trim()) {
                            emptyFields.push(id);
                        }
                    }
                });
                
                console.log(`   - All valid: ${allValid}`);
                console.log(`   - Empty fields: ${emptyFields.length}`);
                
                if (!allValid) {
                    console.log('‚ùå [STAGE 1] FAILED');
                    submitBtn.classList.add('shake');
                    setTimeout(() => submitBtn.classList.remove('shake'), 400);
                    
                    if (tg && typeof tg.showAlert === 'function') {
                        tg.showAlert(t('ui.error_empty'));
                    } else {
                        alert(t('ui.error_empty'));
                    }
                    return;
                }
                
                console.log('‚úÖ [STAGE 1] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
                console.log('‚úÖ [STAGE 2] Disabling button...');
                isSubmitting = true;
                submitBtn.textContent = t('ui.sending');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                console.log('‚úÖ [STAGE 2] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø + 5. –ù–û–†–ú–ê–õ–Ü–ó–ê–¶–Ü–Ø: –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö
                console.log('‚úÖ [STAGE 3] Collecting data...');
                const formData = {};
                
                Object.keys(activeFields).forEach(id => {
                    const el = activeFields[id];
                    let v = (el.value || '').trim();
                    
                    if (!v) return;
                    
                    // 5. –ù–û–†–ú–ê–õ–Ü–ó–ê–¶–Ü–Ø –î–ê–ù–ò–• (–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é)
                    if (el.name === 'iban') {
                        const original = v;
                        v = normalizeIBAN(v); // –í–∏–¥–∞–ª—è—î –í–°–Ü –ø—Ä–æ–±—ñ–ª–∏
                        console.log(`   üîÑ [NORMALIZE] ${el.name}: "${original}" ‚Üí "${v}"`);
                    }
                    if (el.name === 'bic') {
                        const original = v;
                        v = normalizeBIC(v); // –í–∏–¥–∞–ª—è—î –í–°–Ü –ø—Ä–æ–±—ñ–ª–∏
                        console.log(`   üîÑ [NORMALIZE] ${el.name}: "${original}" ‚Üí "${v}"`);
                    }
                    
                    formData[el.name] = v;
                    console.log(`   ‚úÖ Field: ${el.name} = ${v.substring(0, 30)}${v.length > 30 ? '...' : ''}`);
                });
                
                console.log(`   - Total fields: ${Object.keys(formData).length}`);
                console.log('‚úÖ [STAGE 3] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è payload
                console.log('‚úÖ [STAGE 4] Creating payload...');
                const payload = {
                    doc_type: currentDocType,
                    user_answers: formData,  // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: "user_answers"
                    status: 'success'
                };
                console.log('   - doc_type:', payload.doc_type);
                console.log('   - user_answers keys:', Object.keys(payload.user_answers).join(', '));
                console.log('   - status:', payload.status);
                console.log('‚úÖ [STAGE 4] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Telegram API
                console.log('‚úÖ [STAGE 5] Checking Telegram API...');
                if (!tg || typeof tg.sendData !== 'function') {
                    throw new Error('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π! –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –±–æ—Ç.');
                }
                console.log('‚úÖ [STAGE 5] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ JSON
                console.log('‚úÖ [STAGE 6] Converting to JSON...');
                const jsonPayload = JSON.stringify(payload);
                console.log(`   - JSON length: ${jsonPayload.length} chars`);
                console.log(`   - JSON preview: ${jsonPayload.substring(0, 200)}...`);
                console.log('‚úÖ [STAGE 6] PASSED');
                
                // 3. –õ–û–ì–£–í–ê–ù–ù–Ø: –í—ñ–¥–ø—Ä–∞–≤–∫–∞
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üì§ [STAGE 7] CALLING tg.sendData()...');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // 2. –û–ë–†–û–ë–ö–ê sendData –ó –ó–ê–¢–†–ò–ú–ö–û–Æ 100-200ms –î–õ–Ø tg.close()
                tg.sendData(jsonPayload);
                
                console.log('‚úÖ‚úÖ‚úÖ [STAGE 7] SUCCESS! DATA SENT! ‚úÖ‚úÖ‚úÖ');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // –ó–∞–∫—Ä–∏—Ç—Ç—è —á–µ—Ä–µ–∑ 150ms
                setTimeout(() => {
                    console.log('üö™ [CLOSE] Calling tg.close()...');
                    if (tg.close) tg.close();
                }, 150);
                
            } catch (error) {
                // 4. –°–¢–Ü–ô–ö–Ü–°–¢–¨ –î–û –ü–û–ú–ò–õ–û–ö - –æ–±—Ä–æ–±–∫–∞ –±—É–¥—å-—è–∫–∏—Ö –ø–æ–º–∏–ª–æ–∫
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('‚ùå‚ùå‚ùå [ERROR] SUBMIT FAILED');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                if (tg && typeof tg.showAlert === 'function') {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                }
                
                // –°–∫–∏–Ω—É—Ç–∏ —Å—Ç–∞–Ω
                isSubmitting = false;
                submitBtn.textContent = t('ui.submit');
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        submitBtn.addEventListener('click', submitForm);
        form.addEventListener('submit', submitForm);

        // ========================================
        // BACK BUTTON
        // ========================================
        if (tg && tg.BackButton) {
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                if (tg.close) tg.close();
            });
        }

        // ========================================
        // INITIALIZE
        // ========================================
        applyTranslations();
        updateUI();
        
        console.log('‚úÖ [INIT] Complete!');
        console.log('‚úÖ [INIT] Ready to use');

    })();
    </script>
</body>
</html>



























