<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ============================================
           RESET & BASE - TELEGRAM THEME INTEGRATION
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Telegram Theme Variables with Fallbacks */
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1a1a1a);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #3390ec);
            --button-color: var(--tg-theme-button-color, #4caf50);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);
            
            /* Custom App Variables */
            --border-color: #e0e0e0;
            --border-focus: var(--link-color);
            --error-color: #e53935;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --button-disabled: #cccccc;
            --input-bg: var(--secondary-bg);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
        }

        /* ============================================
           CONTAINER
           ============================================ */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 140px;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: var(--hint-color);
        }

        /* ============================================
           DRAFT RESTORED BANNER
           ============================================ */
        .draft-banner {
            background-color: #fff3e0;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid var(--warning-color);
        }

        .draft-banner.visible {
            display: flex;
        }

        .draft-banner-text {
            display: flex;
            align-items: center;
        }

        .draft-banner-text .icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .draft-banner .clear-draft-btn {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .draft-banner .clear-draft-btn:active {
            background-color: rgba(229, 57, 53, 0.1);
        }

        /* Dark theme for draft banner */
        @media (prefers-color-scheme: dark) {
            .draft-banner {
                background-color: #3d2e1a;
            }
        }

        /* ============================================
           SECTION HEADERS
           ============================================ */
        .section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        /* ============================================
           FORM GROUP
           ============================================ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .form-group label .required {
            color: var(--error-color);
            margin-left: 2px;
        }

        /* ============================================
           INPUT FIELDS - CRITICAL FOR TELEGRAM WEBAPP
           NO aggressive event interception!
           ============================================ */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;

            /* CRITICAL: Stability for Telegram WebApp on iOS/Desktop */
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
            cursor: pointer;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.15);
        }

        .form-group input.valid,
        .form-group select.valid {
            border-color: var(--success-color);
        }

        .form-group input.invalid,
        .form-group select.invalid {
            border-color: var(--error-color);
        }

        .form-group input::placeholder {
            color: var(--hint-color);
            opacity: 0.8;
        }

        /* ============================================
           ERROR HINT (ON-SCREEN, NO POPUPS!)
           ============================================ */
        .error-hint {
            font-size: 12px;
            color: var(--error-color);
            margin-top: 4px;
            min-height: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .error-hint.visible {
            visibility: visible;
            opacity: 1;
        }

        /* ============================================
           VALIDATION STATUS BANNER
           ============================================ */
        .validation-status {
            background-color: var(--input-bg);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .validation-status.incomplete {
            border-left: 3px solid var(--error-color);
        }

        .validation-status.complete {
            border-left: 3px solid var(--success-color);
        }

        .validation-status .icon {
            margin-right: 8px;
            font-size: 16px;
        }

        /* ============================================
           DYNAMIC SECTIONS - Hidden by default
           ============================================ */
        .form-section {
            display: none;
        }

        .form-section.visible {
            display: block;
        }

        /* ============================================
           SUBMIT BUTTON - FIXED AT BOTTOM
           ============================================ */
        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(transparent, var(--bg-color) 30%);
            z-index: 100;
        }

        .submit-btn {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: block;
            padding: 16px 24px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;

            /* Prevent tap highlight on iOS */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .submit-btn:disabled {
            background-color: var(--button-disabled);
            color: #888888;
            cursor: not-allowed;
        }

        .submit-btn:not(:disabled) {
            background-color: var(--button-color);
            color: var(--button-text-color);
        }

        .submit-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        .submit-btn.loading {
            background-color: var(--hint-color);
            pointer-events: none;
        }

        /* ============================================
           FORM FOOTER
           ============================================ */
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--hint-color);
        }

        .draft-status {
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .draft-status.visible {
            opacity: 1;
        }

        .draft-status .icon {
            margin-right: 4px;
            font-size: 12px;
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 360px) {
            .container {
                padding: 16px 12px 140px;
            }

            .form-group input,
            .form-group select {
                padding: 12px 14px;
                font-size: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .draft-banner {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header (Dynamic) -->
        <div class="header">
            <h1 id="formTitle">Document Form</h1>
            <p id="formDescription">Fill in the required information</p>
        </div>

        <!-- Draft Restored Banner -->
        <div class="draft-banner" id="draftBanner">
            <div class="draft-banner-text">
                <span class="icon">üìù</span>
                <span>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—É –∞–Ω–∫–µ—Ç—É</span>
            </div>
            <button type="button" class="clear-draft-btn" id="clearDraftBtn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <!-- Validation Status Banner -->
        <div class="validation-status incomplete" id="validationStatus">
            <span class="icon" id="statusIcon">‚ö†Ô∏è</span>
            <span id="statusText">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</span>
        </div>

        <!-- Form -->
        <form id="masterForm" autocomplete="off" novalidate>
            
            <!-- ========== COMMON SECTION (Always Visible) ========== -->
            <div class="form-section visible" id="section_common">
                <div class="section-header">Personal Information</div>
                
                <!-- First Name -->
                <div class="form-group">
                    <label for="first_name">
                        First Name (Vorname) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="first_name" 
                        name="first_name" 
                        placeholder="Enter your first name"
                        autocomplete="given-name"
                        data-section="common"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="first_name_error">Minimum 2 characters</div>
                </div>

                <!-- Last Name -->
                <div class="form-group">
                    <label for="last_name">
                        Last Name (Nachname) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="last_name" 
                        name="last_name" 
                        placeholder="Enter your last name"
                        autocomplete="family-name"
                        data-section="common"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="last_name_error">Minimum 2 characters</div>
                </div>

                <!-- Birth Date -->
                <div class="form-group">
                    <label for="birth_date">
                        Date of Birth (Geburtsdatum) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="birth_date" 
                        name="birth_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="common"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="birth_date_error">Format: DD.MM.YYYY</div>
                </div>
            </div>

            <!-- ========== ANMELDUNG SECTION ========== -->
            <div class="form-section" id="section_anmeldung">
                <div class="section-header">Address Information</div>
                
                <!-- Street -->
                <div class="form-group">
                    <label for="street">
                        Street (Stra√üe) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="street" 
                        name="street" 
                        placeholder="e.g., Hauptstra√üe"
                        autocomplete="street-address"
                        data-section="anmeldung"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="street_error">Minimum 2 characters</div>
                </div>

                <!-- House Number -->
                <div class="form-group">
                    <label for="house_number">
                        House Number (Hausnummer) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="house_number" 
                        name="house_number" 
                        placeholder="e.g., 15a"
                        data-section="anmeldung"
                        data-required="true"
                        data-min="1"
                    >
                    <div class="error-hint" id="house_number_error">Required</div>
                </div>

                <!-- City -->
                <div class="form-group">
                    <label for="city">
                        City (Stadt) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="city" 
                        name="city" 
                        placeholder="e.g., Berlin"
                        autocomplete="address-level2"
                        data-section="anmeldung"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="city_error">Minimum 2 characters</div>
                </div>

                <!-- Postal Code -->
                <div class="form-group">
                    <label for="postal_code">
                        Postal Code (PLZ) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="postal_code" 
                        name="postal_code" 
                        placeholder="12345"
                        inputmode="numeric"
                        maxlength="5"
                        data-section="anmeldung"
                        data-required="true"
                        data-format="plz"
                    >
                    <div class="error-hint" id="postal_code_error">Exactly 5 digits</div>
                </div>

                <!-- Move-in Date -->
                <div class="form-group">
                    <label for="move_in_date">
                        Move-in Date (Einzugsdatum) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="move_in_date" 
                        name="move_in_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="anmeldung"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="move_in_date_error">Format: DD.MM.YYYY</div>
                </div>

                <!-- Previous Address -->
                <div class="form-group">
                    <label for="previous_address">
                        Previous Address (Bisherige Anschrift)
                    </label>
                    <input 
                        type="text" 
                        id="previous_address" 
                        name="previous_address" 
                        placeholder="e.g., Alte Stra√üe 15, 10117 Berlin"
                        data-section="anmeldung"
                        data-required="false"
                        data-min="0"
                    >
                    <div class="error-hint" id="previous_address_error"></div>
                </div>

                <!-- Landlord Name -->
                <div class="form-group">
                    <label for="landlord_name">
                        Landlord Name (Wohnungsgeber) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="landlord_name" 
                        name="landlord_name" 
                        placeholder="Name of property owner"
                        data-section="anmeldung"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="landlord_name_error">Minimum 2 characters</div>
                </div>

                <!-- Religion -->
                <div class="form-group">
                    <label for="religion">
                        Religion (Konfession)
                    </label>
                    <select 
                        id="religion" 
                        name="religion"
                        data-section="anmeldung"
                        data-required="false"
                    >
                        <option value="">-- Select / Ausw√§hlen --</option>
                        <option value="evangelisch">Evangelisch (Protestant)</option>
                        <option value="katholisch">R√∂misch-katholisch (Catholic)</option>
                        <option value="keine">Keine / Konfessionslos (None)</option>
                        <option value="muslimisch">Muslimisch (Muslim)</option>
                        <option value="juedisch">J√ºdisch (Jewish)</option>
                        <option value="orthodox">Orthodox</option>
                        <option value="andere">Andere (Other)</option>
                    </select>
                    <div class="error-hint" id="religion_error"></div>
                </div>

                <!-- Marital Status -->
                <div class="form-group">
                    <label for="marital_status">
                        Marital Status (Familienstand)
                    </label>
                    <select 
                        id="marital_status" 
                        name="marital_status"
                        data-section="anmeldung"
                        data-required="false"
                    >
                        <option value="">-- Select / Ausw√§hlen --</option>
                        <option value="ledig">Ledig (Single)</option>
                        <option value="verheiratet">Verheiratet (Married)</option>
                        <option value="geschieden">Geschieden (Divorced)</option>
                        <option value="verwitwet">Verwitwet (Widowed)</option>
                        <option value="getrennt">Getrennt lebend (Separated)</option>
                        <option value="eingetragene_lebenspartnerschaft">Eingetragene Lebenspartnerschaft (Civil Union)</option>
                    </select>
                    <div class="error-hint" id="marital_status_error"></div>
                </div>
            </div>

            <!-- ========== KINDERGELD SECTION ========== -->
            <div class="form-section" id="section_kindergeld">
                <div class="section-header">Child Information</div>
                
                <!-- Child Name -->
                <div class="form-group">
                    <label for="child_name">
                        Child's Full Name <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="child_name" 
                        name="child_name" 
                        placeholder="Enter child's full name"
                        data-section="kindergeld"
                        data-required="true"
                        data-min="2"
                    >
                    <div class="error-hint" id="child_name_error">Minimum 2 characters</div>
                </div>

                <!-- Child Birth Date -->
                <div class="form-group">
                    <label for="child_birth_date">
                        Child's Date of Birth <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="child_birth_date" 
                        name="child_birth_date"
                        placeholder="DD.MM.YYYY"
                        inputmode="numeric"
                        maxlength="10"
                        data-section="kindergeld"
                        data-required="true"
                        data-format="date"
                    >
                    <div class="error-hint" id="child_birth_date_error">Format: DD.MM.YYYY</div>
                </div>
            </div>

            <!-- ========== FLAT (Wohnung) SECTION ========== -->
            <div class="form-section" id="section_flat">
                <div class="section-header">Housing Application</div>
                
                <!-- Monthly Income -->
                <div class="form-group">
                    <label for="monthly_income">
                        Monthly Net Income (‚Ç¨) <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="monthly_income" 
                        name="monthly_income" 
                        placeholder="e.g., 2500"
                        inputmode="numeric"
                        data-section="flat"
                        data-required="true"
                        data-format="number"
                    >
                    <div class="error-hint" id="monthly_income_error">Enter a valid amount</div>
                </div>

                <!-- Number of People -->
                <div class="form-group">
                    <label for="num_people">
                        Number of People <span class="required">*</span>
                    </label>
                    <select 
                        id="num_people" 
                        name="num_people"
                        data-section="flat"
                        data-required="true"
                    >
                        <option value="">Select...</option>
                        <option value="1">1 person</option>
                        <option value="2">2 people</option>
                        <option value="3">3 people</option>
                        <option value="4">4 people</option>
                        <option value="5">5+ people</option>
                    </select>
                    <div class="error-hint" id="num_people_error">Please select</div>
                </div>

                <!-- Pets -->
                <div class="form-group">
                    <label for="pets">
                        Pets
                    </label>
                    <select 
                        id="pets" 
                        name="pets"
                        data-section="flat"
                        data-required="false"
                    >
                        <option value="">None</option>
                        <option value="cat">Cat</option>
                        <option value="dog_small">Small Dog (under 10kg)</option>
                        <option value="dog_large">Large Dog (over 10kg)</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="error-hint" id="pets_error"></div>
                </div>
            </div>

        </form>

        <!-- Form Footer -->
        <div class="form-footer">
            <div class="field-counter">
                –ó–∞–ø–æ–≤–Ω–µ–Ω–æ: <span id="filledCount">0</span> / <span id="totalCount">0</span> –ø–æ–ª—ñ–≤
            </div>
            <div class="draft-status" id="draftStatus">
                <span class="icon">üíæ</span>
                <span>–ß–µ—Ä–Ω–µ—Ç–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞</span>
            </div>
        </div>
    </div>

    <!-- Submit Button (Fixed at bottom) -->
    <div class="submit-container">
        <button type="button" class="submit-btn" id="submitBtn" disabled>
            –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç
        </button>
    </div>

    <script>
        (function() {
            'use strict';

            // ============================================
            // CONFIGURATION
            // ============================================
            var CONFIG = {
                // Document type configurations
                docTypes: {
                    anmeldung: {
                        title: 'Anmeldung',
                        description: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –º—ñ—Å—Ü–µ–º –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è',
                        sections: ['common', 'anmeldung'],
                        submitText: '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç',
                        requiredFields: 9  // Updated count
                    },
                    kindergeld: {
                        title: 'Kindergeld',
                        description: '–ó–∞—è–≤–∞ –Ω–∞ –¥–æ–ø–æ–º–æ–≥—É –Ω–∞ –¥—ñ—Ç–µ–π',
                        sections: ['common', 'kindergeld'],
                        submitText: '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç',
                        requiredFields: 5
                    },
                    flat: {
                        title: 'Wohnungsantrag',
                        description: '–ó–∞—è–≤–∞ –Ω–∞ –∂–∏—Ç–ª–æ',
                        sections: ['common', 'flat'],
                        submitText: '–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤—É',
                        requiredFields: 5
                    }
                },
                defaultDocType: 'anmeldung',
                draftSaveDelay: 500
            };

            // ============================================
            // GET DOC_TYPE FROM URL
            // ============================================
            function getDocTypeFromURL() {
                var params = new URLSearchParams(window.location.search);
                var docType = params.get('doc_type');
                
                if (docType && CONFIG.docTypes[docType]) {
                    return docType;
                }
                return CONFIG.defaultDocType;
            }

            var currentDocType = getDocTypeFromURL();
            var DRAFT_STORAGE_KEY = 'draft_' + currentDocType;

            // ============================================
            // TELEGRAM WEBAPP INITIALIZATION
            // ============================================
            var tg = window.Telegram && window.Telegram.WebApp;
            
            // Debug logging
            console.log('=== TELEGRAM WEBAPP DEBUG ===');
            console.log('tg object:', tg);
            console.log('tg.sendData available:', !!(tg && tg.sendData));
            console.log('tg.initData:', tg ? tg.initData : 'N/A');
            console.log('tg.initDataUnsafe:', tg ? tg.initDataUnsafe : 'N/A');
            console.log('=============================');
            
            if (tg) {
                tg.ready();
                tg.expand();
            }

            // ============================================
            // DOM ELEMENTS
            // ============================================
            var form = document.getElementById('masterForm');
            var submitBtn = document.getElementById('submitBtn');
            var validationStatus = document.getElementById('validationStatus');
            var statusIcon = document.getElementById('statusIcon');
            var statusText = document.getElementById('statusText');
            var filledCountEl = document.getElementById('filledCount');
            var totalCountEl = document.getElementById('totalCount');
            var draftBanner = document.getElementById('draftBanner');
            var clearDraftBtn = document.getElementById('clearDraftBtn');
            var draftStatus = document.getElementById('draftStatus');
            var formTitle = document.getElementById('formTitle');
            var formDescription = document.getElementById('formDescription');

            var isSubmitting = false;
            var saveTimeout = null;
            var activeFields = {};
            var errorHints = {};

            // ============================================
            // INITIALIZE FORM BASED ON DOC_TYPE
            // ============================================
            function initializeForm() {
                var config = CONFIG.docTypes[currentDocType];
                
                // Set header
                formTitle.textContent = config.title;
                formDescription.textContent = config.description;
                submitBtn.textContent = config.submitText;
                document.title = config.title + ' Form';

                // Show relevant sections
                var sections = document.querySelectorAll('.form-section');
                sections.forEach(function(section) {
                    var sectionId = section.id.replace('section_', '');
                    if (config.sections.indexOf(sectionId) !== -1) {
                        section.classList.add('visible');
                    } else {
                        section.classList.remove('visible');
                    }
                });

                // Collect active fields (only from visible sections)
                activeFields = {};
                errorHints = {};
                
                var allInputs = form.querySelectorAll('input, select');
                allInputs.forEach(function(input) {
                    var section = input.getAttribute('data-section');
                    if (config.sections.indexOf(section) !== -1) {
                        activeFields[input.id] = input;
                        var hint = document.getElementById(input.id + '_error');
                        if (hint) {
                            errorHints[input.id] = hint;
                        }
                    }
                });

                // Update total count
                var requiredCount = 0;
                Object.keys(activeFields).forEach(function(id) {
                    if (activeFields[id].getAttribute('data-required') === 'true') {
                        requiredCount++;
                    }
                });
                totalCountEl.textContent = requiredCount;

                // Attach event listeners
                attachEventListeners();
            }

            // ============================================
            // VALIDATION FUNCTIONS
            // ============================================
            
            function isValidDate(value) {
                if (!value) return false;
                var pattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
                var match = value.match(pattern);
                if (!match) return false;
                
                var day = parseInt(match[1], 10);
                var month = parseInt(match[2], 10);
                var year = parseInt(match[3], 10);
                
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                if (year < 1900 || year > 2030) return false;
                
                return true;
            }

            function isValidPLZ(value) {
                return /^\d{5}$/.test(value);
            }

            function isValidNumber(value) {
                return /^\d+$/.test(value) && parseInt(value, 10) > 0;
            }

            function formatDateInput(input) {
                // Allow digits and dots, remove other characters
                var value = input.value.replace(/[^\d.]/g, '');
                
                // Auto-format: add dots after DD and MM
                var digits = value.replace(/\./g, '');
                var formatted = '';
                
                if (digits.length > 0) {
                    formatted = digits.substring(0, 2);
                }
                if (digits.length > 2) {
                    formatted += '.' + digits.substring(2, 4);
                }
                if (digits.length > 4) {
                    formatted += '.' + digits.substring(4, 8);
                }
                
                // If user manually typed dots, preserve their input
                if (value.includes('.') && value.length <= 10) {
                    // Check if it looks like a valid date pattern
                    if (/^\d{0,2}\.?\d{0,2}\.?\d{0,4}$/.test(value)) {
                        input.value = value;
                        return;
                    }
                }
                
                input.value = formatted;
            }

            function validateField(fieldId, showError) {
                var input = activeFields[fieldId];
                if (!input) return true;
                
                var errorHint = errorHints[fieldId];
                var value = (input.value || '').trim();
                var format = input.getAttribute('data-format');
                var minLength = parseInt(input.getAttribute('data-min'), 10) || 0;
                var isRequired = input.getAttribute('data-required') === 'true';
                var isValid = true;

                // Clear previous state
                input.classList.remove('valid', 'invalid');
                if (errorHint) errorHint.classList.remove('visible');

                if (!isRequired && value.length === 0) {
                    return true;
                }

                if (isRequired && value.length === 0) {
                    if (showError) {
                        input.classList.add('invalid');
                        if (errorHint) errorHint.classList.add('visible');
                    }
                    return false;
                }

                // Validate based on format
                if (format === 'date') {
                    isValid = isValidDate(value);
                } else if (format === 'plz') {
                    isValid = isValidPLZ(value);
                } else if (format === 'number') {
                    isValid = isValidNumber(value);
                } else if (minLength > 0) {
                    isValid = value.length >= minLength;
                } else if (input.tagName === 'SELECT' && isRequired) {
                    isValid = value.length > 0;
                }

                if (isValid) {
                    input.classList.add('valid');
                } else if (showError || value.length > 0) {
                    input.classList.add('invalid');
                    if (errorHint) errorHint.classList.add('visible');
                }

                return isValid;
            }

            function canSubmit() {
                var allValid = true;
                
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    var isRequired = input.getAttribute('data-required') === 'true';
                    
                    if (isRequired) {
                        var value = (input.value || '').trim();
                        var format = input.getAttribute('data-format');
                        var minLength = parseInt(input.getAttribute('data-min'), 10) || 0;

                        if (value.length === 0) {
                            allValid = false;
                        } else if (format === 'date' && !isValidDate(value)) {
                            allValid = false;
                        } else if (format === 'plz' && !isValidPLZ(value)) {
                            allValid = false;
                        } else if (format === 'number' && !isValidNumber(value)) {
                            allValid = false;
                        } else if (minLength > 0 && value.length < minLength) {
                            allValid = false;
                        }
                    }
                });

                return allValid;
            }

            function updateUI() {
                var isValid = canSubmit();
                submitBtn.disabled = !isValid || isSubmitting;

                if (isValid) {
                    validationStatus.classList.remove('incomplete');
                    validationStatus.classList.add('complete');
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = '–§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏';
                } else {
                    validationStatus.classList.remove('complete');
                    validationStatus.classList.add('incomplete');
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è";
                }

                updateFieldCounter();
            }

            function updateFieldCounter() {
                var count = 0;
                
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    if (input.getAttribute('data-required') === 'true') {
                        if (input.value.trim().length > 0) {
                            count++;
                        }
                    }
                });
                
                filledCountEl.textContent = count;
            }

            // ============================================
            // DRAFT STORAGE FUNCTIONS
            // ============================================

            function saveDraft() {
                try {
                    var draftData = {};
                    var hasData = false;

                    Object.keys(activeFields).forEach(function(id) {
                        var value = activeFields[id].value.trim();
                        if (value) {
                            draftData[id] = value;
                            hasData = true;
                        }
                    });

                    if (hasData) {
                        draftData._timestamp = Date.now();
                        draftData._docType = currentDocType;
                        localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draftData));
                        showDraftSavedIndicator();
                    } else {
                        localStorage.removeItem(DRAFT_STORAGE_KEY);
                        hideDraftSavedIndicator();
                    }
                } catch (e) {
                    console.warn('Could not save draft:', e);
                }
            }

            function debouncedSaveDraft() {
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                saveTimeout = setTimeout(saveDraft, CONFIG.draftSaveDelay);
            }

            function loadDraft() {
                try {
                    var savedData = localStorage.getItem(DRAFT_STORAGE_KEY);
                    if (!savedData) return false;

                    var draftData = JSON.parse(savedData);
                    var hasRestored = false;

                    Object.keys(activeFields).forEach(function(id) {
                        if (draftData[id]) {
                            activeFields[id].value = draftData[id];
                            hasRestored = true;
                        }
                    });

                    return hasRestored;
                } catch (e) {
                    console.warn('Could not load draft:', e);
                    return false;
                }
            }

            function clearDraft() {
                try {
                    localStorage.removeItem(DRAFT_STORAGE_KEY);
                } catch (e) {
                    console.warn('Could not clear draft:', e);
                }

                Object.keys(activeFields).forEach(function(id) {
                    activeFields[id].value = '';
                    activeFields[id].classList.remove('valid', 'invalid');
                    if (errorHints[id]) {
                        errorHints[id].classList.remove('visible');
                    }
                });

                draftBanner.classList.remove('visible', 'fade-in');
                hideDraftSavedIndicator();
                updateUI();
            }

            function showDraftSavedIndicator() {
                draftStatus.classList.add('visible');
            }

            function hideDraftSavedIndicator() {
                draftStatus.classList.remove('visible');
            }

            // ============================================
            // EVENT HANDLERS
            // ============================================
            
            function attachEventListeners() {
                Object.keys(activeFields).forEach(function(id) {
                    var input = activeFields[id];
                    var format = input.getAttribute('data-format');

                    input.addEventListener('input', function() {
                        if (format === 'date') {
                            formatDateInput(input);
                        }
                        if (format === 'plz' || format === 'number') {
                            input.value = input.value.replace(/\D/g, '');
                        }
                        
                        validateField(id, false);
                        updateUI();
                        debouncedSaveDraft();
                    });

                    input.addEventListener('blur', function() {
                        var value = (input.value || '').trim();
                        if (value.length > 0 || input.getAttribute('data-required') === 'true') {
                            validateField(id, true);
                        }
                    });

                    // For select elements
                    if (input.tagName === 'SELECT') {
                        input.addEventListener('change', function() {
                            validateField(id, false);
                            updateUI();
                            debouncedSaveDraft();
                        });
                    }
                });
            }

            // Clear Draft Button
            clearDraftBtn.addEventListener('click', function(e) {
                e.preventDefault();
                clearDraft();
            });

            // ============================================
            // SUBMIT HANDLER
            // ============================================
            
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();

                if (isSubmitting) return;

                // Final validation
                var allValid = true;
                Object.keys(activeFields).forEach(function(id) {
                    if (!validateField(id, true)) {
                        allValid = false;
                    }
                });

                if (!allValid) {
                    submitBtn.classList.add('shake');
                    setTimeout(function() {
                        submitBtn.classList.remove('shake');
                    }, 400);
                    return;
                }

                // Set loading state
                isSubmitting = true;
                submitBtn.textContent = '–ì–µ–Ω–µ—Ä—É—î–º–æ...';
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                // Collect form data
                var userAnswers = {};
                Object.keys(activeFields).forEach(function(id) {
                    var value = activeFields[id].value.trim();
                    if (value) {
                        userAnswers[id] = value;
                    }
                });

                // Build payload - MUST include status: "success" for bot!
                var payload = {
                    doc_type: currentDocType,
                    user_answers: userAnswers,
                    status: 'success'  // CRITICAL: Bot expects this!
                };

                console.log('=== SENDING TO TELEGRAM ===');
                console.log('Payload:', JSON.stringify(payload, null, 2));
                console.log('tg available:', !!tg);
                console.log('tg.sendData available:', !!(tg && tg.sendData));
                console.log('===========================');

                // Clear draft
                try {
                    localStorage.removeItem(DRAFT_STORAGE_KEY);
                } catch (e) {
                    console.warn('Could not clear draft:', e);
                }

                // Send data to Telegram
                if (tg && tg.sendData) {
                    try {
                        var jsonString = JSON.stringify(payload);
                        console.log('Calling tg.sendData with:', jsonString);
                        tg.sendData(jsonString);
                        console.log('tg.sendData called successfully');
                        
                        // Wait before closing to ensure data is sent
                        setTimeout(function() {
                            console.log('Calling tg.close()');
                            if (tg.close) {
                                tg.close();
                            }
                        }, 500);
                    } catch (err) {
                        console.error('Error in tg.sendData:', err);
                    }
                } else {
                    console.warn('WebApp not available or not opened via Telegram button!');
                    console.warn('tg:', tg);
                    console.warn('To test: Open this WebApp via InlineKeyboardButton with web_app=WebAppInfo(url=...)');
                    
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = '–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ (—Ç–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º)';
                    validationStatus.classList.remove('incomplete');
                    validationStatus.classList.add('complete');
                    
                    draftBanner.classList.remove('visible', 'fade-in');
                    hideDraftSavedIndicator();

                    setTimeout(function() {
                        isSubmitting = false;
                        submitBtn.textContent = CONFIG.docTypes[currentDocType].submitText;
                        submitBtn.classList.remove('loading');
                        submitBtn.disabled = false;
                    }, 2000);
                }
            });

            // ============================================
            // TELEGRAM BACK BUTTON
            // Back button –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î WebApp –±–µ–∑ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ cancelled
            // –î–∞–Ω—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –≤ —á–µ—Ä–Ω–µ—Ç—Ü—ñ –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –ø—ñ–∑–Ω—ñ—à–µ
            // ============================================
            
            if (tg && tg.BackButton) {
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    // –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ WebApp –±–µ–∑ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å—É
                    // –ß–µ—Ä–Ω–µ—Ç–∫–∞ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≤ localStorage
                    console.log('Back button pressed - closing without sending cancelled status');
                    
                    if (tg.close) {
                        tg.close();
                    }
                });
            }

            // ============================================
            // INITIALIZATION
            // ============================================
            
            initializeForm();
            
            var draftRestored = loadDraft();
            
            if (draftRestored) {
                draftBanner.classList.add('visible', 'fade-in');
                
                Object.keys(activeFields).forEach(function(id) {
                    validateField(id, false);
                });
            }
            
            updateUI();
            console.log('Master Form initialized: doc_type=' + currentDocType + (draftRestored ? ' (draft restored)' : ''));

        })();
    </script>
</body>
</html>






