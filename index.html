<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1a1a1a);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #3390ec);
            --button-color: var(--tg-theme-button-color, #4caf50);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);
            --border-color: #e0e0e0;
            --border-focus: var(--link-color);
            --error-color: #e53935;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --button-disabled: #cccccc;
            --input-bg: var(--secondary-bg);
        }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 140px;
        }
        .header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 14px;
            color: var(--hint-color);
        }
        .section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .section-header:first-of-type {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-color);
        }
        .form-group label .required {
            color: var(--error-color);
            margin-left: 2px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
            cursor: pointer;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.15);
        }
        .form-group input.valid,
        .form-group select.valid {
            border-color: var(--success-color);
        }
        .form-group input.invalid,
        .form-group select.invalid {
            border-color: var(--error-color);
        }
        .error-hint {
            font-size: 12px;
            color: var(--error-color);
            margin-top: 4px;
            min-height: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .error-hint.visible {
            visibility: visible;
            opacity: 1;
        }
        .validation-status {
            background-color: var(--input-bg);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .validation-status.incomplete {
            border-left: 3px solid var(--error-color);
        }
        .validation-status.complete {
            border-left: 3px solid var(--success-color);
        }
        .validation-status .icon {
            margin-right: 8px;
            font-size: 16px;
        }
        .form-section {
            display: none;
        }
        .form-section.visible {
            display: block;
        }
        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(transparent, var(--bg-color) 30%);
            z-index: 100;
        }
        .submit-btn {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: block;
            padding: 16px 24px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .submit-btn:disabled {
            background-color: var(--button-disabled);
            color: #888888;
            cursor: not-allowed;
        }
        .submit-btn:not(:disabled) {
            background-color: var(--button-color);
            color: var(--button-text-color);
        }
        .submit-btn:not(:disabled):active {
            transform: scale(0.98);
        }
        .submit-btn.loading {
            background-color: var(--hint-color);
            pointer-events: none;
        }
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--hint-color);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="formTitle">Document Form</h1>
            <p id="formDescription">Fill in the required information</p>
        </div>

        <div class="validation-status incomplete" id="validationStatus">
            <span class="icon" id="statusIcon">⚠️</span>
            <span id="statusText">Fill required fields</span>
        </div>

        <form id="masterForm" autocomplete="off" novalidate>
            <!-- PERSONAL SECTION -->
            <div class="form-section visible" id="section_personal">
                <div class="section-header" data-i18n="section.personal">Personal Data</div>

                <div class="form-group">
                    <label for="first_name">
                        <span data-i18n="label.first_name">First Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="first_name" name="first_name" 
                           data-i18n-placeholder="placeholder.first_name"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_first_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="last_name">
                        <span data-i18n="label.last_name">Last Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="last_name" name="last_name"
                           data-i18n-placeholder="placeholder.last_name"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_last_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="birth_date">
                        <span data-i18n="label.birth_date">Birth Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="birth_date" name="birth_date" 
                           data-i18n-placeholder="placeholder.birth_date"
                           inputmode="numeric" maxlength="10" 
                           data-section="personal" data-required="true" data-format="date">
                    <div class="error-hint" id="err_birth_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>

                <div class="form-group">
                    <label for="birth_place">
                        <span data-i18n="label.birth_place">Birth Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="birth_place" name="birth_place"
                           data-i18n-placeholder="placeholder.birth_place"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_birth_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="nationality">
                        <span data-i18n="label.nationality">Nationality</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="nationality" name="nationality"
                           data-i18n-placeholder="placeholder.nationality"
                           data-section="personal" data-required="true" data-min="2">
                    <div class="error-hint" id="err_nationality" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="marital_status">
                        <span data-i18n="label.marital_status">Marital Status</span>
                        <span class="required">*</span>
                    </label>
                    <select id="marital_status" name="marital_status" data-section="personal" data-required="true">
                        <option value="" data-i18n="select.empty">-- Select --</option>
                        <option value="single" data-i18n="select.marital.single">Single</option>
                        <option value="married" data-i18n="select.marital.married">Married</option>
                        <option value="divorced" data-i18n="select.marital.divorced">Divorced</option>
                        <option value="widowed" data-i18n="select.marital.widowed">Widowed</option>
                        <option value="separated" data-i18n="select.marital.separated">Separated</option>
                        <option value="civil_union" data-i18n="select.marital.civil_union">Civil Union</option>
                    </select>
                    <div class="error-hint" id="err_marital_status" data-i18n="error.select">Please select</div>
                </div>

                <div class="form-group">
                    <label for="religion">
                        <span data-i18n="label.religion">Religion</span>
                        <span class="required">*</span>
                    </label>
                    <select id="religion" name="religion" data-section="personal" data-required="true">
                        <option value="" data-i18n="select.empty">-- Select --</option>
                        <option value="none" data-i18n="select.religion.none">None</option>
                        <option value="protestant" data-i18n="select.religion.protestant">Protestant</option>
                        <option value="catholic" data-i18n="select.religion.catholic">Catholic</option>
                        <option value="orthodox" data-i18n="select.religion.orthodox">Orthodox</option>
                        <option value="muslim" data-i18n="select.religion.muslim">Muslim</option>
                        <option value="jewish" data-i18n="select.religion.jewish">Jewish</option>
                        <option value="other" data-i18n="select.religion.other">Other</option>
                    </select>
                    <div class="error-hint" id="err_religion" data-i18n="error.select">Please select</div>
                </div>
            </div>

            <!-- ADDRESS SECTION -->
            <div class="form-section" id="section_address">
                <div class="section-header" data-i18n="section.address">Address</div>

                <div class="form-group">
                    <label for="street">
                        <span data-i18n="label.street">Street</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="street" name="street"
                           data-i18n-placeholder="placeholder.street"
                           data-section="address" data-required="true" data-min="2">
                    <div class="error-hint" id="err_street" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="house_number">
                        <span data-i18n="label.house_number">House Number</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="house_number" name="house_number"
                           data-i18n-placeholder="placeholder.house_number"
                           data-section="address" data-required="true" data-min="1">
                    <div class="error-hint" id="err_house_number" data-i18n="error.required">Required</div>
                </div>

                <div class="form-group">
                    <label for="postal_code">
                        <span data-i18n="label.postal_code">Postal Code</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="postal_code" name="postal_code"
                           data-i18n-placeholder="placeholder.postal_code"
                           inputmode="numeric" maxlength="5"
                           data-section="address" data-required="true" data-format="plz">
                    <div class="error-hint" id="err_postal_code" data-i18n="error.plz">Exactly 5 digits</div>
                </div>

                <div class="form-group">
                    <label for="city">
                        <span data-i18n="label.city">City</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="city" name="city"
                           data-i18n-placeholder="placeholder.city"
                           data-section="address" data-required="true" data-min="2">
                    <div class="error-hint" id="err_city" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group" id="group_previous_address">
                    <label for="previous_address">
                        <span data-i18n="label.previous_address">Previous Address</span>
                    </label>
                    <input type="text" id="previous_address" name="previous_address"
                           data-i18n-placeholder="placeholder.previous_address"
                           data-section="address" data-required="false">
                    <div class="error-hint" id="err_previous_address"></div>
                </div>

                <div class="form-group" id="group_move_in_date">
                    <label for="move_in_date">
                        <span data-i18n="label.move_in_date">Move-in Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="move_in_date" name="move_in_date"
                           data-i18n-placeholder="placeholder.move_in_date"
                           inputmode="numeric" maxlength="10"
                           data-section="address" data-required="true" data-format="date">
                    <div class="error-hint" id="err_move_in_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>
            </div>

            <!-- HOUSING SECTION -->
            <div class="form-section" id="section_housing">
                <div class="section-header" data-i18n="section.housing">Housing</div>

                <div class="form-group">
                    <label for="landlord_name">
                        <span data-i18n="label.landlord_name">Landlord Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="landlord_name" name="landlord_name"
                           data-i18n-placeholder="placeholder.landlord_name"
                           data-section="housing" data-required="true" data-min="2">
                    <div class="error-hint" id="err_landlord_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- BANK SECTION -->
            <div class="form-section" id="section_bank">
                <div class="section-header" data-i18n="section.bank">Bank Details</div>

                <div class="form-group">
                    <label for="iban">
                        <span data-i18n="label.iban">IBAN</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="iban" name="iban"
                           data-i18n-placeholder="placeholder.iban"
                           inputmode="text" maxlength="42"
                           data-section="bank" data-required="true" data-format="iban">
                    <div class="error-hint" id="err_iban" data-i18n="error.iban">Enter valid IBAN</div>
                </div>

                <div class="form-group">
                    <label for="bic">
                        <span data-i18n="label.bic">BIC</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="bic" name="bic"
                           data-i18n-placeholder="placeholder.bic"
                           inputmode="text" maxlength="11"
                           data-section="bank" data-required="true" data-format="bic">
                    <div class="error-hint" id="err_bic" data-i18n="error.bic">8-11 characters</div>
                </div>

                <div class="form-group">
                    <label for="account_holder">
                        <span data-i18n="label.account_holder">Account Holder</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="account_holder" name="account_holder"
                           data-i18n-placeholder="placeholder.account_holder"
                           data-section="bank" data-required="true" data-min="2">
                    <div class="error-hint" id="err_account_holder" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- CHILD SECTION -->
            <div class="form-section" id="section_child">
                <div class="section-header" data-i18n="section.child">Child Information</div>

                <div class="form-group">
                    <label for="child_first_name">
                        <span data-i18n="label.child_first_name">Child First Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_first_name" name="child_first_name"
                           data-i18n-placeholder="placeholder.child_first_name"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_first_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_last_name">
                        <span data-i18n="label.child_last_name">Child Last Name</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_last_name" name="child_last_name"
                           data-i18n-placeholder="placeholder.child_last_name"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_last_name" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_birth_date">
                        <span data-i18n="label.child_birth_date">Child Birth Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_birth_date" name="child_birth_date"
                           data-i18n-placeholder="placeholder.child_birth_date"
                           inputmode="numeric" maxlength="10"
                           data-section="child" data-required="true" data-format="date">
                    <div class="error-hint" id="err_child_birth_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>

                <div class="form-group">
                    <label for="child_birth_place">
                        <span data-i18n="label.child_birth_place">Child Birth Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_birth_place" name="child_birth_place"
                           data-i18n-placeholder="placeholder.child_birth_place"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_birth_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="child_nationality">
                        <span data-i18n="label.child_nationality">Child Nationality</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="child_nationality" name="child_nationality"
                           data-i18n-placeholder="placeholder.child_nationality"
                           data-section="child" data-required="true" data-min="2">
                    <div class="error-hint" id="err_child_nationality" data-i18n="error.min2">Minimum 2 characters</div>
                </div>
            </div>

            <!-- SIGNATURE SECTION -->
            <div class="form-section" id="section_signature">
                <div class="section-header" data-i18n="section.signature">Signature</div>

                <div class="form-group">
                    <label for="signature_place">
                        <span data-i18n="label.signature_place">Signature Place</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="signature_place" name="signature_place"
                           data-i18n-placeholder="placeholder.signature_place"
                           data-section="signature" data-required="true" data-min="2">
                    <div class="error-hint" id="err_signature_place" data-i18n="error.min2">Minimum 2 characters</div>
                </div>

                <div class="form-group">
                    <label for="signature_date">
                        <span data-i18n="label.signature_date">Signature Date</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="signature_date" name="signature_date"
                           data-i18n-placeholder="placeholder.signature_date"
                           inputmode="numeric" maxlength="10"
                           data-section="signature" data-required="true" data-format="date">
                    <div class="error-hint" id="err_signature_date" data-i18n="error.date">Format: DD.MM.YYYY</div>
                </div>
            </div>
        </form>

        <div class="form-footer">
            <div class="field-counter">
                <span data-i18n="ui.filled">Filled:</span>
                <span id="filledCount">0</span> /
                <span id="totalCount">0</span>
                <span data-i18n="ui.fields">fields</span>
            </div>
        </div>
    </div>

    <div class="submit-container">
        <button type="button" class="submit-btn" id="submitBtn" disabled data-i18n="ui.submit">Submit</button>
    </div>
<script>
(function() {
    'use strict';

    // ========================================
    // КРИТИЧНО: ОДНЕ ОГОЛОШЕННЯ TG НА ПОЧАТКУ
    // ========================================
    const tg = window.Telegram && window.Telegram.WebApp;
    
    console.log('[WebApp] ========================================');
    console.log('[WebApp] INITIALIZATION');
    console.log('[WebApp] ========================================');
    console.log('[WebApp] window.Telegram:', window.Telegram);
    console.log('[WebApp] tg:', tg);
    console.log('[WebApp] tg.sendData:', tg ? tg.sendData : 'N/A');
    
    if (!tg) {
        console.error('[WebApp] ❌ CRITICAL: Telegram WebApp API NOT AVAILABLE!');
        alert('❌ ПОМИЛКА!\n\nWebApp може працювати ТІЛЬКИ через Telegram бот.\n\nВідкрийте цю сторінку через кнопку в боті!');
    } else {
        console.log('[WebApp] ✅ Telegram WebApp API available');
        tg.ready();
        tg.expand();
        console.log('[WebApp] ✅ tg.ready() and tg.expand() called');
    }

    // ========================================
    // TRANSLATIONS
    // ========================================
    const TRANSLATIONS = {
        ua: {
            title: { anmeldung: 'Anmeldung (Реєстрація)', kindergeld: 'Kindergeld (Допомога на дітей)' },
            description: { anmeldung: 'Реєстрація за місцем проживання', kindergeld: 'Заява на допомогу на дітей' },
            section: {
                personal: 'Особисті дані',
                address: 'Адреса проживання',
                housing: 'Житлові дані',
                bank: 'Банківські реквізити',
                child: 'Дані дитини',
                signature: 'Підпис'
            },
            label: {
                first_name: "Ім'я",
                last_name: 'Прізвище',
                birth_date: 'Дата народження',
                birth_place: 'Місце народження',
                nationality: 'Громадянство',
                marital_status: 'Сімейний стан',
                religion: 'Віросповідання',
                street: 'Вулиця',
                house_number: 'Номер будинку',
                postal_code: 'Поштовий індекс (PLZ)',
                city: 'Місто',
                previous_address: 'Попередня адреса',
                move_in_date: 'Дата заїзду',
                landlord_name: 'ПІБ орендодавця',
                iban: 'IBAN',
                bic: 'BIC',
                account_holder: 'Власник рахунку',
                child_first_name: "Ім'я дитини",
                child_last_name: 'Прізвище дитини',
                child_birth_date: 'Дата народження дитини',
                child_birth_place: 'Місце народження дитини',
                child_nationality: 'Громадянство дитини',
                signature_place: 'Місто (для підпису)',
                signature_date: 'Дата (для підпису)'
            },
            placeholder: {
                first_name: "Введіть ваше ім'я",
                last_name: 'Введіть ваше прізвище',
                birth_date: 'ДД.ММ.РРРР',
                birth_place: 'напр., Київ',
                nationality: 'напр., ukrainisch',
                street: 'напр., Hauptstraße',
                house_number: 'напр., 15a',
                postal_code: '12345',
                city: 'напр., Berlin',
                previous_address: 'напр., Alte Straße 15, 10117 Berlin',
                move_in_date: 'ДД.ММ.РРРР',
                landlord_name: "Повне ім'я орендодавця",
                iban: 'DE00 0000 0000 0000 0000 00',
                bic: 'COBADEFFXXX',
                account_holder: 'напр., Max Mustermann',
                child_first_name: "Введіть ім'я дитини",
                child_last_name: 'Введіть прізвище дитини',
                child_birth_date: 'ДД.ММ.РРРР',
                child_birth_place: 'напр., Berlin',
                child_nationality: 'напр., deutsch',
                signature_place: 'напр., Berlin',
                signature_date: 'ДД.ММ.РРРР'
            },
            error: {
                min2: 'Мінімум 2 символи',
                required: "Обов'язкове поле",
                date: 'Формат: ДД.ММ.РРРР',
                plz: 'Рівно 5 цифр',
                iban: 'Введіть коректний IBAN',
                bic: '8-11 символів',
                select: 'Оберіть значення',
                cyrillic: 'Використовуйте латинські літери'
            },
            select: {
                empty: '-- Оберіть --',
                marital: {
                    single: 'Неодружений/неодружена',
                    married: 'Одружений/заміжня',
                    divorced: 'Розлучений/розлучена',
                    widowed: 'Вдівець/вдова',
                    separated: 'Окремо проживає',
                    civil_union: 'Цивільне партнерство'
                },
                religion: {
                    none: 'Немає',
                    protestant: 'Протестантство',
                    catholic: 'Католицизм',
                    orthodox: 'Православ\'я',
                    muslim: 'Іслам',
                    jewish: 'Іудаїзм',
                    other: 'Інше'
                }
            },
            ui: {
                incomplete: "Заповніть обов'язкові поля",
                ready: 'Форма готова до відправки',
                filled: 'Заповнено:',
                fields: 'полів',
                submit: 'Згенерувати PDF',
                sending: 'Відправляємо...',
                error_empty: 'Будь ласка, заповніть всі обов\'язкові поля!',
                error_validation: 'Деякі поля заповнені неправильно'
            }
        },
        de: {
            title: { anmeldung: 'Anmeldung', kindergeld: 'Kindergeld' },
            description: { anmeldung: 'Wohnsitz-Anmeldung', kindergeld: 'Antrag auf Kindergeld' },
            section: {
                personal: 'Persönliche Daten',
                address: 'Anschrift',
                housing: 'Wohnungsdaten',
                bank: 'Bankverbindung',
                child: 'Angaben zum Kind',
                signature: 'Unterschrift'
            },
            label: {
                first_name: 'Vorname',
                last_name: 'Nachname',
                birth_date: 'Geburtsdatum',
                birth_place: 'Geburtsort',
                nationality: 'Staatsangehörigkeit',
                marital_status: 'Familienstand',
                religion: 'Religionszugehörigkeit',
                street: 'Straße',
                house_number: 'Hausnummer',
                postal_code: 'Postleitzahl (PLZ)',
                city: 'Ort',
                previous_address: 'Bisherige Anschrift',
                move_in_date: 'Einzugsdatum',
                landlord_name: 'Wohnungsgeber (Name)',
                iban: 'IBAN',
                bic: 'BIC',
                account_holder: 'Kontoinhaber',
                child_first_name: 'Vorname des Kindes',
                child_last_name: 'Nachname des Kindes',
                child_birth_date: 'Geburtsdatum des Kindes',
                child_birth_place: 'Geburtsort des Kindes',
                child_nationality: 'Staatsangehörigkeit des Kindes',
                signature_place: 'Ort (Unterschrift)',
                signature_date: 'Datum (Unterschrift)'
            },
            placeholder: {
                first_name: 'Vornamen eingeben',
                last_name: 'Nachnamen eingeben',
                birth_date: 'TT.MM.JJJJ',
                birth_place: 'z.B. Berlin',
                nationality: 'z.B. deutsch',
                street: 'z.B. Hauptstraße',
                house_number: 'z.B. 15a',
                postal_code: '12345',
                city: 'z.B. Berlin',
                previous_address: 'z.B. Alte Straße 15, 10117 Berlin',
                move_in_date: 'TT.MM.JJJJ',
                landlord_name: 'Vollständiger Name',
                iban: 'DE00 0000 0000 0000 0000 00',
                bic: 'COBADEFFXXX',
                account_holder: 'z.B. Max Mustermann',
                child_first_name: 'Vornamen eingeben',
                child_last_name: 'Nachnamen eingeben',
                child_birth_date: 'TT.MM.JJJJ',
                child_birth_place: 'z.B. Berlin',
                child_nationality: 'z.B. deutsch',
                signature_place: 'z.B. Berlin',
                signature_date: 'TT.MM.JJJJ'
            },
            error: {
                min2: 'Mindestens 2 Zeichen',
                required: 'Pflichtfeld',
                date: 'Format: TT.MM.JJJJ',
                plz: 'Genau 5 Ziffern',
                iban: 'Gültige IBAN eingeben',
                bic: '8-11 Zeichen',
                select: 'Bitte auswählen',
                cyrillic: 'Verwenden Sie lateinische Buchstaben'
            },
            select: {
                empty: '-- Auswählen --',
                marital: {
                    single: 'Ledig',
                    married: 'Verheiratet',
                    divorced: 'Geschieden',
                    widowed: 'Verwitwet',
                    separated: 'Getrennt lebend',
                    civil_union: 'Eingetragene Lebenspartnerschaft'
                },
                religion: {
                    none: 'Keine',
                    protestant: 'Evangelisch',
                    catholic: 'Katholisch',
                    orthodox: 'Orthodox',
                    muslim: 'Muslimisch',
                    jewish: 'Jüdisch',
                    other: 'Andere'
                }
            },
            ui: {
                incomplete: 'Bitte Pflichtfelder ausfüllen',
                ready: 'Formular bereit zum Absenden',
                filled: 'Ausgefüllt:',
                fields: 'Felder',
                submit: 'PDF erstellen',
                sending: 'Sende...',
                error_empty: 'Bitte füllen Sie alle Pflichtfelder aus!',
                error_validation: 'Einige Felder sind nicht korrekt ausgefüllt'
            }
        },
        en: {
            title: { anmeldung: 'Registration (Anmeldung)', kindergeld: 'Child Benefit (Kindergeld)' },
            description: { anmeldung: 'Residence registration', kindergeld: 'Child benefit application' },
            section: {
                personal: 'Personal Information',
                address: 'Address',
                housing: 'Housing Information',
                bank: 'Bank Details',
                child: 'Child Information',
                signature: 'Signature'
            },
            label: {
                first_name: 'First Name',
                last_name: 'Last Name',
                birth_date: 'Date of Birth',
                birth_place: 'Place of Birth',
                nationality: 'Nationality',
                marital_status: 'Marital Status',
                religion: 'Religion',
                street: 'Street',
                house_number: 'House Number',
                postal_code: 'Postal Code',
                city: 'City',
                previous_address: 'Previous Address',
                move_in_date: 'Move-in Date',
                landlord_name: 'Landlord Name',
                iban: 'IBAN',
                bic: 'BIC',
                account_holder: 'Account Holder',
                child_first_name: 'Child\'s First Name',
                child_last_name: 'Child\'s Last Name',
                child_birth_date: 'Child\'s Date of Birth',
                child_birth_place: 'Child\'s Place of Birth',
                child_nationality: 'Child\'s Nationality',
                signature_place: 'Place (Signature)',
                signature_date: 'Date (Signature)'
            },
            placeholder: {
                first_name: 'Enter first name',
                last_name: 'Enter last name',
                birth_date: 'DD.MM.YYYY',
                birth_place: 'e.g. London',
                nationality: 'e.g. British',
                street: 'e.g. Main Street',
                house_number: 'e.g. 15a',
                postal_code: '12345',
                city: 'e.g. Berlin',
                previous_address: 'e.g. Old Street 15, 10117 Berlin',
                move_in_date: 'DD.MM.YYYY',
                landlord_name: 'Full name',
                iban: 'DE00 0000 0000 0000 0000 00',
                bic: 'COBADEFFXXX',
                account_holder: 'e.g. Max Mustermann',
                child_first_name: 'Enter child\'s first name',
                child_last_name: 'Enter child\'s last name',
                child_birth_date: 'DD.MM.YYYY',
                child_birth_place: 'e.g. Berlin',
                child_nationality: 'e.g. German',
                signature_place: 'e.g. Berlin',
                signature_date: 'DD.MM.YYYY'
            },
            error: {
                min2: 'Minimum 2 characters',
                required: 'Required field',
                date: 'Format: DD.MM.YYYY',
                plz: 'Exactly 5 digits',
                iban: 'Enter valid IBAN',
                bic: '8-11 characters',
                select: 'Please select',
                cyrillic: 'Use Latin characters'
            },
            select: {
                empty: '-- Select --',
                marital: {
                    single: 'Single',
                    married: 'Married',
                    divorced: 'Divorced',
                    widowed: 'Widowed',
                    separated: 'Separated',
                    civil_union: 'Civil Partnership'
                },
                religion: {
                    none: 'None',
                    protestant: 'Protestant',
                    catholic: 'Catholic',
                    orthodox: 'Orthodox',
                    muslim: 'Muslim',
                    jewish: 'Jewish',
                    other: 'Other'
                }
            },
            ui: {
                incomplete: 'Please fill required fields',
                ready: 'Form ready to submit',
                filled: 'Filled:',
                fields: 'fields',
                submit: 'Generate PDF',
                sending: 'Sending...',
                error_empty: 'Please fill all required fields!',
                error_validation: 'Some fields are not correctly filled'
            }
        },
        tr: {
            title: { anmeldung: 'Kayıt (Anmeldung)', kindergeld: 'Çocuk Parası (Kindergeld)' },
            description: { anmeldung: 'İkamet kaydı', kindergeld: 'Çocuk parası başvurusu' },
            section: {
                personal: 'Kişisel Bilgiler',
                address: 'Adres',
                housing: 'Konut Bilgileri',
                bank: 'Banka Bilgileri',
                child: 'Çocuk Bilgileri',
                signature: 'İmza'
            },
            label: {
                first_name: 'Ad',
                last_name: 'Soyad',
                birth_date: 'Doğum Tarihi',
                birth_place: 'Doğum Yeri',
                nationality: 'Uyruk',
                marital_status: 'Medeni Durum',
                religion: 'Din',
                street: 'Sokak',
                house_number: 'Ev Numarası',
                postal_code: 'Posta Kodu',
                city: 'Şehir',
                previous_address: 'Önceki Adres',
                move_in_date: 'Taşınma Tarihi',
                landlord_name: 'Ev Sahibi Adı',
                iban: 'IBAN',
                bic: 'BIC',
                account_holder: 'Hesap Sahibi',
                child_first_name: 'Çocuğun Adı',
                child_last_name: 'Çocuğun Soyadı',
                child_birth_date: 'Çocuğun Doğum Tarihi',
                child_birth_place: 'Çocuğun Doğum Yeri',
                child_nationality: 'Çocuğun Uyruğu',
                signature_place: 'Yer (İmza)',
                signature_date: 'Tarih (İmza)'
            },
            placeholder: {
                first_name: 'Adınızı girin',
                last_name: 'Soyadınızı girin',
                birth_date: 'GG.AA.YYYY',
                birth_place: 'örn. İstanbul',
                nationality: 'örn. Türk',
                street: 'örn. Ana Cadde',
                house_number: 'örn. 15a',
                postal_code: '12345',
                city: 'örn. Berlin',
                previous_address: 'örn. Eski Sokak 15, 10117 Berlin',
                move_in_date: 'GG.AA.YYYY',
                landlord_name: 'Tam ad',
                iban: 'DE00 0000 0000 0000 0000 00',
                bic: 'COBADEFFXXX',
                account_holder: 'örn. Max Mustermann',
                child_first_name: 'Çocuğun adını girin',
                child_last_name: 'Çocuğun soyadını girin',
                child_birth_date: 'GG.AA.YYYY',
                child_birth_place: 'örn. Berlin',
                child_nationality: 'örn. Alman',
                signature_place: 'örn. Berlin',
                signature_date: 'GG.AA.YYYY'
            },
            error: {
                min2: 'En az 2 karakter',
                required: 'Zorunlu alan',
                date: 'Format: GG.AA.YYYY',
                plz: 'Tam 5 rakam',
                iban: 'Geçerli IBAN girin',
                bic: '8-11 karakter',
                select: 'Lütfen seçin',
                cyrillic: 'Latin harfleri kullanın'
            },
            select: {
                empty: '-- Seçin --',
                marital: {
                    single: 'Bekar',
                    married: 'Evli',
                    divorced: 'Boşanmış',
                    widowed: 'Dul',
                    separated: 'Ayrı yaşıyor',
                    civil_union: 'Sivil Birlik'
                },
                religion: {
                    none: 'Yok',
                    protestant: 'Protestan',
                    catholic: 'Katolik',
                    orthodox: 'Ortodoks',
                    muslim: 'Müslüman',
                    jewish: 'Yahudi',
                    other: 'Diğer'
                }
            },
            ui: {
                incomplete: 'Lütfen zorunlu alanları doldurun',
                ready: 'Form göndermeye hazır',
                filled: 'Dolduruldu:',
                fields: 'alan',
                submit: 'PDF Oluştur',
                sending: 'Gönderiliyor...',
                error_empty: 'Lütfen tüm zorunlu alanları doldurun!',
                error_validation: 'Bazı alanlar doğru doldurulmamış'
            }
        }
    };

    // ========================================
    // URL PARAMS
    // ========================================
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        let docType = (params.get('doc_type') || 'anmeldung').toLowerCase();
        let lang = (params.get('lang') || 'ua').toLowerCase();
        
        if (lang === 'uk') lang = 'ua';
        
        const supported = ['ua', 'de', 'en', 'tr'];
        if (!supported.includes(lang)) lang = 'ua';
        
        return { docType, lang };
    }

    const PARAMS = getUrlParams();
    const currentDocType = PARAMS.docType;
    const currentLang = PARAMS.lang;
    
    console.log('[WebApp] Document type:', currentDocType);
    console.log('[WebApp] Language:', currentLang);

    // ========================================
    // TRANSLATION FUNCTION
    // ========================================
    function t(path) {
        const keys = path.split('.');
        let obj = TRANSLATIONS[currentLang] || TRANSLATIONS.ua;
        
        for (let i = 0; i < keys.length; i++) {
            if (!obj || typeof obj !== 'object') return path;
            obj = obj[keys[i]];
        }
        
        return obj || path;
    }

    // ========================================
    // APPLY TRANSLATIONS
    // ========================================
    function applyTranslations() {
        console.log('[WebApp] Applying translations...');
        
        document.getElementById('formTitle').textContent = t('title.' + currentDocType);
        document.getElementById('formDescription').textContent = t('description.' + currentDocType);
        document.title = t('title.' + currentDocType);
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = t(el.getAttribute('data-i18n'));
        });
        
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
        });
        
        console.log('[WebApp] ✅ Translations applied');
    }

    // ========================================
    // DOC TYPE CONFIG
    // ========================================
    const DOCS = {
        anmeldung: { sections: ['personal', 'address', 'housing', 'signature'] },
        kindergeld: { sections: ['personal', 'address', 'bank', 'child', 'signature'] }
    };

    // ========================================
    // SECTIONS VISIBILITY
    // ========================================
    const sectionMap = {
        personal: document.getElementById('section_personal'),
        address: document.getElementById('section_address'),
        housing: document.getElementById('section_housing'),
        bank: document.getElementById('section_bank'),
        child: document.getElementById('section_child'),
        signature: document.getElementById('section_signature')
    };

    Object.keys(sectionMap).forEach(k => {
        if (sectionMap[k]) sectionMap[k].classList.remove('visible');
    });
    
    DOCS[currentDocType].sections.forEach(k => {
        if (sectionMap[k]) sectionMap[k].classList.add('visible');
    });

    if (currentDocType === 'kindergeld') {
        const pg = document.getElementById('group_previous_address');
        const mg = document.getElementById('group_move_in_date');
        if (pg) pg.style.display = 'none';
        if (mg) mg.style.display = 'none';
    }

    // ========================================
    // COLLECT ACTIVE FIELDS
    // ========================================
    const form = document.getElementById('masterForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const validationStatus = document.getElementById('validationStatus');
    const filledCountEl = document.getElementById('filledCount');
    const totalCountEl = document.getElementById('totalCount');
    
    let activeFields = {};
    let errorHints = {};
    let isSubmitting = false;

    function collectActiveFields() {
        activeFields = {};
        errorHints = {};
        
        const allControls = form.querySelectorAll('input, select');
        allControls.forEach(ctrl => {
            const section = ctrl.closest('.form-section');
            if (!section || !section.classList.contains('visible')) return;
            
            const group = ctrl.closest('.form-group');
            if (group && group.style.display === 'none') return;
            
            activeFields[ctrl.id] = ctrl;
            const hint = document.getElementById('err_' + ctrl.id);
            if (hint) errorHints[ctrl.id] = hint;
        });
        
        let requiredCount = 0;
        Object.keys(activeFields).forEach(id => {
            if (activeFields[id].getAttribute('data-required') === 'true') requiredCount++;
        });
        
        totalCountEl.textContent = requiredCount;
    }

    collectActiveFields();

    // ========================================
    // VALIDATION FUNCTIONS
    // ========================================
    function isValidDate(value) {
        if (!value) return false;
        const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
        if (!m) return false;
        const d = parseInt(m[1], 10), mo = parseInt(m[2], 10), y = parseInt(m[3], 10);
        return mo >= 1 && mo <= 12 && d >= 1 && d <= 31 && y >= 1900 && y <= 2100;
    }

    function formatDateInput(input) {
        const digits = input.value.replace(/[^\d]/g, '');
        let formatted = '';
        if (digits.length > 0) formatted = digits.substring(0, 2);
        if (digits.length > 2) formatted += '.' + digits.substring(2, 4);
        if (digits.length > 4) formatted += '.' + digits.substring(4, 8);
        input.value = formatted;
    }

    function isValidPLZ(value) {
        return /^\d{5}$/.test(value);
    }

    function normalizeIBAN(raw) {
        return (raw || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    function formatIBAN(raw) {
        const v = normalizeIBAN(raw);
        let formatted = '';
        for (let i = 0; i < v.length; i++) {
            if (i > 0 && i % 4 === 0) formatted += ' ';
            formatted += v[i];
        }
        return formatted.trim();
    }

    function isValidIBAN(value) {
        const v = normalizeIBAN(value);
        return v.length >= 15 && v.length <= 34 && /^[A-Z]{2}\d{2}[A-Z0-9]+$/.test(v);
    }

    function normalizeBIC(raw) {
        return (raw || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    function isValidBIC(value) {
        const v = normalizeBIC(value);
        return /^[A-Z0-9]{8}([A-Z0-9]{3})?$/.test(v);
    }

    function hasCyrillic(text) {
        return /[а-яёА-ЯЁ]/.test(text);
    }

    function validateField(fieldId, showError) {
        const input = activeFields[fieldId];
        if (!input) return true;
        
        const hint = errorHints[fieldId];
        const value = (input.value || '').trim();
        const format = input.getAttribute('data-format');
        const minLen = parseInt(input.getAttribute('data-min'), 10) || 0;
        const isReq = input.getAttribute('data-required') === 'true';
        let valid = true;

        input.classList.remove('valid', 'invalid');
        if (hint) hint.classList.remove('visible');

        if (!isReq && !value) return true;
        if (isReq && !value) {
            if (showError) {
                input.classList.add('invalid');
                if (hint) {
                    hint.textContent = t('error.required');
                    hint.classList.add('visible');
                }
            }
            return false;
        }

        if (currentLang !== 'ua' && ['first_name', 'last_name', 'nationality', 'birth_place', 'city', 'street'].includes(fieldId)) {
            if (hasCyrillic(value)) {
                if (hint) {
                    hint.textContent = t('error.cyrillic');
                    hint.classList.add('visible');
                }
                input.classList.add('invalid');
                return false;
            }
        }

        if (format === 'date') valid = isValidDate(value);
        else if (format === 'plz') valid = isValidPLZ(value);
        else if (format === 'iban') valid = isValidIBAN(value);
        else if (format === 'bic') valid = isValidBIC(value);
        else if (minLen > 0) valid = value.length >= minLen;
        else if (input.tagName === 'SELECT' && isReq) valid = value.length > 0;

        if (valid) {
            input.classList.add('valid');
        } else if (showError || value) {
            input.classList.add('invalid');
            if (hint) hint.classList.add('visible');
        }
        
        return valid;
    }

    function canSubmit() {
        let allValid = true;
        Object.keys(activeFields).forEach(id => {
            const inp = activeFields[id];
            if (inp.getAttribute('data-required') !== 'true') return;
            
            const v = (inp.value || '').trim();
            if (!v) {
                allValid = false;
                return;
            }
            
            const fmt = inp.getAttribute('data-format');
            const minL = parseInt(inp.getAttribute('data-min'), 10) || 0;
            
            if (fmt === 'date' && !isValidDate(v)) allValid = false;
            else if (fmt === 'plz' && !isValidPLZ(v)) allValid = false;
            else if (fmt === 'iban' && !isValidIBAN(v)) allValid = false;
            else if (fmt === 'bic' && !isValidBIC(v)) allValid = false;
            else if (minL > 0 && v.length < minL) allValid = false;
            
            if (currentLang !== 'ua' && ['first_name', 'last_name', 'nationality', 'birth_place', 'city', 'street'].includes(id)) {
                if (hasCyrillic(v)) allValid = false;
            }
        });
        return allValid;
    }

    function updateFieldCounter() {
        let count = 0;
        Object.keys(activeFields).forEach(id => {
            if (activeFields[id].getAttribute('data-required') === 'true' && (activeFields[id].value || '').trim()) {
                count++;
            }
        });
        filledCountEl.textContent = count;
    }

    function updateUI() {
        const ready = canSubmit();
        submitBtn.disabled = !ready || isSubmitting;
        
        if (ready) {
            validationStatus.classList.remove('incomplete');
            validationStatus.classList.add('complete');
            statusIcon.textContent = '✅';
            statusText.textContent = t('ui.ready');
        } else {
            validationStatus.classList.remove('complete');
            validationStatus.classList.add('incomplete');
            statusIcon.textContent = '⚠️';
            statusText.textContent = t('ui.incomplete');
        }
        
        updateFieldCounter();
    }

    // ========================================
    // INPUT EVENTS
    // ========================================
    Object.keys(activeFields).forEach(id => {
        const inp = activeFields[id];
        const fmt = inp.getAttribute('data-format');

        inp.addEventListener('input', () => {
            if (fmt === 'date') formatDateInput(inp);
            else if (fmt === 'plz') inp.value = inp.value.replace(/\D/g, '').slice(0, 5);
            else if (fmt === 'iban') inp.value = formatIBAN(inp.value).slice(0, 42);
            else if (fmt === 'bic') inp.value = normalizeBIC(inp.value).slice(0, 11);
            
            validateField(id, false);
            updateUI();
        });

        inp.addEventListener('blur', () => {
            const v = (inp.value || '').trim();
            if (v || inp.getAttribute('data-required') === 'true') {
                validateField(id, true);
            }
        });

        if (inp.tagName === 'SELECT') {
            inp.addEventListener('change', () => {
                validateField(id, false);
                updateUI();
            });
        }
    });

    // ========================================
    // КРИТИЧНО: SUBMIT HANDLER
    // ========================================
  // ============================================================================
// БЛОК 1: ПОВНА ФУНКЦІЯ submitForm() ДЛЯ index.html
// ============================================================================
// Замініть весь код SUBMIT HANDLER (від рядка ~1339 до ~1443)
// Шукайте коментар: // ========================================
//                    // SUBMIT HANDLER
//                    // ========================================

// ========================================
// SUBMIT HANDLER - ФІНАЛЬНА ВЕРСІЯ
// ========================================
function submitForm(e) {
    if (e) e.preventDefault();
    
    console.log('═══════════════════════════════════════════════════════════');
    console.log('🚀 SUBMIT FUNCTION CALLED');
    console.log('═══════════════════════════════════════════════════════════');
    
    if (isSubmitting) {
        console.log('⏸️ Already submitting, ignoring duplicate click');
        return;
    }
    
    console.log('✅ Step 1: Starting validation...');
    
    // КРОК 1: ВАЛІДАЦІЯ ВСІХ ПОЛІВ
    var allValid = true;
    var emptyFields = [];
    var invalidFields = [];
    
    Object.keys(activeFields).forEach(function(id) {
        var field = activeFields[id];
        var isValid = validateField(id, true);
        
        if (!isValid) {
            allValid = false;
            if (field.getAttribute('data-required') === 'true') {
                var value = (field.value || '').trim();
                if (!value) {
                    emptyFields.push(id);
                } else {
                    invalidFields.push(id);
                }
            }
        }
    });
    
    console.log('📊 Validation results:');
    console.log('   - All valid:', allValid);
    console.log('   - Empty required fields:', emptyFields);
    console.log('   - Invalid fields:', invalidFields);
    
    if (!allValid) {
        console.log('❌ Step 1 FAILED: Validation errors');
        console.log('═══════════════════════════════════════════════════════════');
        
        submitBtn.classList.add('shake');
        setTimeout(function() { submitBtn.classList.remove('shake'); }, 400);
        
        var errorMsg = t('ui.error_empty');
        if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert(errorMsg);
        } else {
            alert(errorMsg);
        }
        return;
    }
    
    console.log('✅ Step 1 PASSED: All fields valid');
    console.log('✅ Step 2: Setting submitting state...');
    
    // КРОК 2: БЛОКУВАННЯ ПОВТОРНОЇ ВІДПРАВКИ
    isSubmitting = true;
    submitBtn.textContent = t('ui.sending');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    console.log('✅ Step 2 PASSED: Button disabled');
    console.log('✅ Step 3: Collecting form data...');
    
    // КРОК 3: ЗБІР ДАНИХ З ФОРМИ
    var formData = {};
    var fieldCount = 0;
    
    Object.keys(activeFields).forEach(function(id) {
        var el = activeFields[id];
        var v = (el.value || '').trim();
        
        if (!v) {
            console.log('   ⏭️ Skipping empty field:', id);
            return;
        }
        
        // Нормалізація спеціальних полів
        if (el.name === 'iban') {
            var original = v;
            v = normalizeIBAN(v);
            console.log('   🔄 Normalized IBAN:', original, '→', v);
        }
        if (el.name === 'bic') {
            var original = v;
            v = normalizeBIC(v);
            console.log('   🔄 Normalized BIC:', original, '→', v);
        }
        
        formData[el.name] = v;
        fieldCount++;
        console.log('   ✅ Added field:', el.name, '=', v.substring(0, 50) + (v.length > 50 ? '...' : ''));
    });
    
    console.log('📊 Form data collected:');
    console.log('   - Total fields:', fieldCount);
    console.log('   - Field names:', Object.keys(formData));
    console.log('✅ Step 3 PASSED: Form data collected');
    console.log('✅ Step 4: Creating payload...');
    
    // КРОК 4: ФОРМУВАННЯ PAYLOAD (КРИТИЧНО ВАЖЛИВА СТРУКТУРА!)
    var payload = {
        doc_type: currentDocType,
        user_answers: formData,  // ← КРИТИЧНО: ключ "user_answers", НЕ "form_data"!
        status: 'success'
    };
    
    console.log('📦 Payload structure:');
    console.log('   - doc_type:', payload.doc_type);
    console.log('   - user_answers keys:', Object.keys(payload.user_answers));
    console.log('   - user_answers count:', Object.keys(payload.user_answers).length);
    console.log('   - status:', payload.status);
    console.log('📦 Full payload object:', payload);
    console.log('✅ Step 4 PASSED: Payload created');
    console.log('✅ Step 5: Checking Telegram API...');
    
    // КРОК 5: ПЕРЕВІРКА НАЯВНОСТІ TELEGRAM API
    console.log('🔍 Telegram API check:');
    console.log('   - window.Telegram exists:', !!window.Telegram);
    console.log('   - tg exists:', !!tg);
    console.log('   - tg.sendData exists:', !!(tg && tg.sendData));
    console.log('   - typeof tg.sendData:', tg ? typeof tg.sendData : 'N/A');
    
    if (!tg || typeof tg.sendData !== 'function') {
        console.error('❌ CRITICAL ERROR: Telegram WebApp API not available!');
        console.error('   This means the form was NOT opened through Telegram bot');
        console.error('   The form MUST be opened by clicking the button in Telegram');
        console.log('═══════════════════════════════════════════════════════════');
        
        alert('❌ ПОМИЛКА!\n\nWebApp може працювати ТІЛЬКИ через Telegram бот.\n\nВідкрийте форму натиснувши кнопку в боті.');
        
        // Скинути стан
        isSubmitting = false;
        submitBtn.textContent = t('ui.submit');
        submitBtn.classList.remove('loading');
        updateUI();
        return;
    }
    
    console.log('✅ Step 5 PASSED: Telegram API available');
    console.log('✅ Step 6: Converting to JSON...');
    
    // КРОК 6: КОНВЕРТАЦІЯ В JSON
    var jsonPayload;
    try {
        jsonPayload = JSON.stringify(payload);
        console.log('📄 JSON payload:');
        console.log('   - Length:', jsonPayload.length, 'characters');
        console.log('   - First 200 chars:', jsonPayload.substring(0, 200));
        console.log('   - Full JSON:', jsonPayload);
        console.log('✅ Step 6 PASSED: JSON created successfully');
    } catch (jsonError) {
        console.error('❌ Step 6 FAILED: JSON.stringify error:', jsonError);
        console.log('═══════════════════════════════════════════════════════════');
        
        alert('❌ Помилка конвертації даних: ' + jsonError.message);
        
        isSubmitting = false;
        submitBtn.textContent = t('ui.submit');
        submitBtn.classList.remove('loading');
        updateUI();
        return;
    }
    console.log('✅ Step 7: Sending data via tg.sendData()...');
    
    // КРОК 7: ВІДПРАВКА ДАНИХ В TELEGRAM
    try {
        tg.sendData(jsonPayload);
        console.log('✅✅✅ SUCCESS! tg.sendData() CALLED ✅✅✅');
        console.log('👋 Closing WebApp...');
        
        // Закриваємо вікно анкети через 100мс
        setTimeout(function() {
            tg.close();
        }, 100);
        
    } catch (sendError) {
        console.error('❌ Step 7 FAILED: tg.sendData error:', sendError);
        alert('❌ Помилка відправки в Telegram: ' + sendError.message);
        
        isSubmitting = false;
        if (submitBtn) {
            submitBtn.textContent = t('ui.submit');
            submitBtn.classList.remove('loading');
        }
    }
    console.log('═══════════════════════════════════════════════════════════');
}
    
    console.log('✅ Step 7: Sending data to bot...');
    console.log('═══════════════════════════════════════════════════════════');
    console.log('📤 CALLING tg.sendData()...');
    console.log('═══════════════════════════════════════════════════════════');
    
    // КРОК 7: ВІДПРАВКА ДАНИХ БОТУ
    try {
        tg.sendData(jsonPayload);
        
        console.log('═══════════════════════════════════════════════════════════');
        console.log('✅✅✅ SUCCESS! tg.sendData() CALLED ✅✅✅');
        console.log('═══════════════════════════════════════════════════════════');
        console.log('📊 Summary:');
        console.log('   - Document type:', currentDocType);
        console.log('   - Fields sent:', fieldCount);
        console.log('   - Payload size:', jsonPayload.length, 'chars');
        console.log('   - Status: Data sent to bot successfully');
        console.log('═══════════════════════════════════════════════════════════');
        console.log('⏳ WebApp will close automatically in 500ms...');
        
        // Показати повідомлення користувачу
        if (tg && typeof tg.showPopup === 'function') {
            tg.showPopup({
                title: '✅ Успіх!',
                message: 'Дані відправлено боту. Зачекайте, генеруємо PDF...',
                buttons: [{type: 'close'}]
            });
        }
        
        // Закрити WebApp через 500мс
        setTimeout(function() {
            console.log('🚪 Calling tg.close()...');
            if (tg.close) {
                tg.close();
                console.log('✅ tg.close() called - WebApp should close now');
            }
        }, 500);
        
    } catch (sendError) {
        console.error('═══════════════════════════════════════════════════════════');
        console.error('❌❌❌ CRITICAL ERROR IN tg.sendData() ❌❌❌');
        console.error('═══════════════════════════════════════════════════════════');
        console.error('Error object:', sendError);
        console.error('Error name:', sendError.name);
        console.error('Error message:', sendError.message);
        console.error('Error stack:', sendError.stack);
        console.error('═══════════════════════════════════════════════════════════');
        
        var errorMsg = 'Помилка відправки даних:\n' + (sendError.message || 'Невідома помилка');
        if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert(errorMsg);
        } else {
            alert(errorMsg);
        }
        
        // Скинути стан
        isSubmitting = false;
        submitBtn.textContent = t('ui.submit');
        submitBtn.classList.remove('loading');
        updateUI();
    }
}

// ПРИВ'ЯЗАТИ ФУНКЦІЮ ДО КНОПКИ
submitBtn.addEventListener('click', submitForm);

// Також обробити submit форми
form.addEventListener('submit', submitForm);

console.log('✅ submitForm() function registered');
console.log('✅ Event listeners attached to button and form');

        // ✅ 3. PAYLOAD STRUCTURE (як ви просили)
       const payload = {
            doc_type: currentDocType,
            user_answers: formData,  // ✅ ОСЬ ТУТ МИ ЗМІНИЛИ form_data НА user_answers
            status: 'success'
        };

        console.log('[WebApp] ========================================');
        console.log('[WebApp] PAYLOAD READY');
        console.log('[WebApp] ========================================');
        console.log('[WebApp] doc_type:', payload.doc_type);
        console.log('[WebApp] user_answers fields:', Object.keys(payload.user_answers).length);
        console.log('[WebApp] user_answers:', payload.user_answers);
        console.log('[WebApp] status:', payload.status);
        console.log('[WebApp] Full payload:', JSON.stringify(payload, null, 2));

        // ✅ 2. SEND DATA (як ви просили - tg.sendData)
        if (!tg || typeof tg.sendData !== 'function') {
            console.error('[WebApp] ❌ CRITICAL: Telegram WebApp API not available!');
            console.error('[WebApp] tg:', tg);
            console.error('[WebApp] typeof tg.sendData:', typeof (tg ? tg.sendData : undefined));
            
            alert('❌ ПОМИЛКА!\n\nTelegram WebApp API недоступний.\n\nВідкрийте форму через кнопку в Telegram боті!');
            
            isSubmitting = false;
            submitBtn.textContent = t('ui.submit');
            submitBtn.classList.remove('loading');
            updateUI();
            return;
        }

        try {
            const jsonPayload = JSON.stringify(payload);
            
            console.log('[WebApp] ========================================');
            console.log('[WebApp] CALLING tg.sendData()');
            console.log('[WebApp] ========================================');
            console.log('[WebApp] JSON payload length:', jsonPayload.length);
            console.log('[WebApp] JSON payload:', jsonPayload);
            
            // ✅ SEND DATA TO BOT
            tg.sendData(jsonPayload);
            
            console.log('[WebApp] ✅✅✅ tg.sendData() CALLED SUCCESSFULLY! ✅✅✅');
            console.log('[WebApp] Data has been sent to the bot');
            console.log('[WebApp] WebApp should close automatically now...');
            
            // Show success message
            alert('✅ Дані відправлено боту!\n\nЗараз форма закриється автоматично.');
            
            // ✅ 4. CLOSE WEBAPP (як ви просили)
            setTimeout(() => {
                console.log('[WebApp] Calling tg.close()...');
                if (tg.close) {
                    tg.close();
                    console.log('[WebApp] ✅ tg.close() called');
                }
            }, 500);
            
        } catch (error) {
            console.error('[WebApp] ❌❌❌ CRITICAL ERROR in sendData() ❌❌❌');
            console.error('[WebApp] Error:', error);
            console.error('[WebApp] Error message:', error.message);
            console.error('[WebApp] Error stack:', error.stack);
            
            const errorMsg = 'Помилка відправки:\n' + (error.message || 'Невідома помилка');
            if (tg && typeof tg.showAlert === 'function') {
                tg.showAlert(errorMsg);
            } else {
                alert(errorMsg);
            }
            
            isSubmitting = false;
            submitBtn.textContent = t('ui.submit');
            submitBtn.classList.remove('loading');
            updateUI();
        }
    }

    // ✅ ATTACH SUBMIT HANDLER TO BUTTON
    submitBtn.addEventListener('click', submitForm);
    
    // Also handle form submit event
    form.addEventListener('submit', submitForm);

    // ========================================
    // BACK BUTTON
    // ========================================
    if (tg && tg.BackButton) {
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            console.log('[WebApp] Back button clicked');
            if (tg.close) tg.close();
        });
    }

    // ========================================
    // INITIALIZE
    // ========================================
    applyTranslations();
    updateUI();
    
    console.log('[WebApp] ========================================');
    console.log('[WebApp] INITIALIZATION COMPLETE');
    console.log('[WebApp] ========================================');
    console.log('[WebApp] Language:', currentLang);
    console.log('[WebApp] Document:', currentDocType);
    console.log('[WebApp] Active fields:', Object.keys(activeFields).length);
    console.log('[WebApp] Telegram API available:', !!tg);
    console.log('[WebApp] tg.sendData available:', !!(tg && tg.sendData));
    console.log('[WebApp] Ready to accept user input');

})();
</script>

</body>
</html>

























